<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Community Leaderboards</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #FFFFFF;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3CradialGradient id='a' cx='0' cy='800' r='800' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23ebb4b4'/%3E%3Cstop offset='1' stop-color='%23ebb4b4' stop-opacity='0'/%3E%3C/radialGradient%3E%3CradialGradient id='b' cx='1200' cy='800' r='800' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23eaccb5'/%3E%3Cstop offset='1' stop-color='%23eaccb5' stop-opacity='0'/%3E%3C/radialGradient%3E%3CradialGradient id='c' cx='600' cy='0' r='600' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23d56011'/%3E%3Cstop offset='1' stop-color='%23d56011' stop-opacity='0'/%3E%3C/radialGradient%3E%3CradialGradient id='d' cx='600' cy='800' r='600' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23FFFFFF'/%3E%3Cstop offset='1' stop-color='%23FFFFFF' stop-opacity='0'/%3E%3C/radialGradient%3E%3CradialGradient id='e' cx='0' cy='0' r='800' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23D60000'/%3E%3Cstop offset='1' stop-color='%23D60000' stop-opacity='0'/%3E%3C/radialGradient%3E%3CradialGradient id='f' cx='1200' cy='0' r='800' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23D48818'/%3E%3Cstop offset='1' stop-color='%23D48818' stop-opacity='0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect fill='url(%23a)' width='1200' height='800'/%3E%3Crect fill='url(%23b)' width='1200' height='800'/%3E%3Crect fill='url(%23c)' width='1200' height='800'/%3E%3Crect fill='url(%23d)' width='1200' height='800'/%3E%3Crect fill='url(%23e)' width='1200' height='800'/%3E%3Crect fill='url(%23f)' width='1200' height='800'/%3E%3C/svg%3E");
      background-attachment: fixed;
      background-size: cover;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Background overlay for mobile */
    @media (max-width: 768px) {
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.95);
        z-index: -1;
      }
      body {
        background-attachment: scroll;
        background-position: center;
        background-size: auto 100%;
      }
    }

    /* Header styles */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      position: relative;
      z-index: 10;
      width: 100vw;
      margin-left: calc(-50vw + 50%);
    }

    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Card styles */
    .leaderboard-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-radius: 16px;
      overflow: hidden;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      max-width: 90%;
      width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Rank badge styles */
    .rank-badge {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: 700;
    }

    .rank-1 {
      background: linear-gradient(135deg, #FFD700 0%, #FFC600 100%);
      color: #7a5c00;
    }

    .rank-2 {
      background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
      color: #4a4a4a;
    }

    .rank-3 {
      background: linear-gradient(135deg, #CD7F32 0%, #B87333 100%);
      color: #5a3a1a;
    }

    /* Tab styles */
    .tab-active {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }

    /* Anti-cheat styles */
    .cheat-warning {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ff4444;
      color: white;
      padding: 1rem;
      text-align: center;
      z-index: 2000;
      display: none;
    }

    /* Loading spinner */
    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .header {
        padding: 0.8rem;
      }
      
      .leaderboard-card {
        border-radius: 12px;
      }
      
      .user-avatar {
        width: 40px;
        height: 40px;
      }
      
      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .tab-text {
        display: none;
      }
      
      .tab-icon {
        margin-right: 0;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Cheat warning -->
  <div id="cheatWarning" class="cheat-warning">
    <div class="flex items-center justify-center space-x-2">
      <i data-lucide="alert-triangle" class="w-5 h-5"></i>
      <span>Warning: Suspicious activity detected!</span>
    </div>
  </div>

  <!-- Header with navigation -->
  <header class="header p-4 mb-8">
    <div class="header-container flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-900 font-playfair">Community Leaderboards</h1>
      <div class="flex space-x-2">
        <button onclick="window.location.href='menu.html'" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
          <i data-lucide="home" class="w-5 h-5 text-gray-700"></i>
        </button>
        <button onclick="logout()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
          <i data-lucide="log-out" class="w-5 h-5 text-gray-700"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4">
    <!-- Main Navigation -->
    <div class="flex justify-center mb-8 fade-in">
      <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg shadow-inner">
        <button
          id="mindfulnessBtn"
          class="py-3 px-6 rounded-md font-medium transition-colors flex items-center tab-active text-blue-600"
        >
          <i data-lucide="brain" class="w-5 h-5 mr-2 tab-icon"></i>
          <span class="tab-text">üßò‚Äç‚ôÄÔ∏è Monk-ness LeaderBoard</span>
        </button>
        <button
          id="nutritionBtn"
          class="py-3 px-6 rounded-md font-medium transition-colors flex items-center text-slate-600 hover:text-slate-900"
        >
          <i data-lucide="carrot" class="w-5 h-5 mr-2 tab-icon"></i>
          <span class="tab-text">ü•ó Nutri Board</span>
        </button>
      </div>
    </div>

    <!-- Leaderboard Content -->
    <div id="mindfulnessLeaderboard" class="fade-in"></div>
    <div id="nutritionLeaderboard" class="hidden fade-in"></div>
  </div>

  <!-- Modal for terms -->
  <div id="termsModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900 font-playfair">Term Definitions</h3>
        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <h4 class="font-semibold text-gray-900">Mindfulness</h4>
          <p class="text-gray-600">The practice of being fully present and engaged in the current moment.</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900">Nutrition</h4>
          <p class="text-gray-600">The process of providing or obtaining the food necessary for health and growth.</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900">Breathing Level</h4>
          <p class="text-gray-600">Your progress in mastering breathing techniques and exercises.</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900">Meditation</h4>
          <p class="text-gray-600">A practice where an individual uses a technique to train attention and awareness.</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900">Focus Sessions</h4>
          <p class="text-gray-600">Periods of concentrated work or study with minimized distractions.</p>
        </div>
      </div>
      <button onclick="closeModal()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors">
        Close
      </button>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div id="quizModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900 font-playfair">Nutrition Quiz</h3>
        <button onclick="closeQuizModal()" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div id="quizContent" class="space-y-4">
        <!-- Quiz content will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Supabase configuration
    const SUPABASE_URL = 'https://fhthwxgkxuontprzclhb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZodGh3eGdreHVvbnRwcnpjbGhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDczNDgsImV4cCI6MjA2OTYyMzM0OH0.9mEHL1jpYXkMeWg0UNKK5LYPosj0eou4k-mw3eof-ZU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // OpenRouter configuration
    const OPENROUTER_API_KEY = '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';
    
    // App state
    const state = {
      activeView: 'mindfulness',
      activeMindfulnessTab: 'breathing',
      activeNutritionTab: 'correct',
      showQuiz: false,
      currentQuestion: 0,
      selectedAnswer: null,
      showResult: false,
      score: 0,
      userGrade: 'middle',
      quizQuestions: [],
      isGeneratingQuiz: false,
      isScreenBlocked: false,
      suspiciousActivity: 0,
      quizStartTime: null,
      tabSwitchCount: 0,
      isWindowFocused: true,
      currentUser: null,
      topMindfulnessUser: null,
      topNutritionUser: null,
      testUsers: [
        {
          id: '11111111-1111-1111-1111-111111111111',
          username: 'MindfulMaster',
          avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
          breathing_level: 15,
          total_breathing_sessions: 42,
          meditation_minutes: 1200,
          focus_sessions: 85
        },
        {
          id: '22222222-2222-2222-2222-222222222222',
          username: 'NutritionNinja',
          avatar_url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face',
          correct_answers: 38,
          wrong_answers: 5,
          total_answers: 43,
          accuracy: 88
        }
      ]
    };

    // DOM elements
    const elements = {
      mindfulnessBtn: document.getElementById('mindfulnessBtn'),
      nutritionBtn: document.getElementById('nutritionBtn'),
      mindfulnessLeaderboard: document.getElementById('mindfulnessLeaderboard'),
      nutritionLeaderboard: document.getElementById('nutritionLeaderboard'),
      termsModal: document.getElementById('termsModal'),
      quizModal: document.getElementById('quizModal'),
      quizContent: document.getElementById('quizContent'),
      cheatWarning: document.getElementById('cheatWarning')
    };

    // Initialize the app
    async function init() {
      try {
        await checkAuth();
        await fetchTopUsers();
        renderMindfulnessLeaderboard();
        setupEventListeners();
        setupAntiCheat();
      } catch (error) {
        console.error('Error initializing app:', error);
        // Continue with test data
        state.topMindfulnessUser = state.testUsers[0];
        state.topNutritionUser = state.testUsers[1];
        renderMindfulnessLeaderboard();
        setupEventListeners();
        setupAntiCheat();
      }
    }

    // Anti-cheat measures
    function setupAntiCheat() {
      // Track window focus
      window.addEventListener('focus', () => {
        state.isWindowFocused = true;
      });
      
      window.addEventListener('blur', () => {
        state.isWindowFocused = false;
        if (state.quizStartTime) {
          state.suspiciousActivity++;
          checkSuspiciousActivity();
        }
      });
      
      // Track tab switching
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && state.quizStartTime) {
          state.tabSwitchCount++;
          state.suspiciousActivity++;
          checkSuspiciousActivity();
        }
      });
      
      // Track quick answers
      let lastAnswerTime = null;
      
      window.selectAnswer = (index) => {
        const now = Date.now();
        if (lastAnswerTime && (now - lastAnswerTime) < 1000) {
          state.suspiciousActivity++;
          checkSuspiciousActivity();
        }
        lastAnswerTime = now;
        state.selectedAnswer = index;
        renderQuizQuestion();
      };
    }
    
    function checkSuspiciousActivity() {
      if (state.suspiciousActivity > 2) {
        elements.cheatWarning.style.display = 'block';
        setTimeout(() => {
          elements.cheatWarning.style.display = 'none';
        }, 5000);
        
        // Reset quiz if cheating detected
        if (state.quizStartTime) {
          closeQuizModal();
          state.suspiciousActivity = 0;
          state.tabSwitchCount = 0;
        }
      }
    }

    // Check authentication
    async function checkAuth() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) return;
        
        state.currentUser = user;
        
        // Get user's grade level
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('grade_level')
          .eq('id', user.id)
          .single();
        
        if (profile?.grade_level) {
          state.userGrade = profile.grade_level.toLowerCase().replace('th', '').replace(' grade', '');
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }

    // Logout function
    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (!error) {
        window.location.href = 'index.html';
      }
    }

    // Fetch top users for each leaderboard
    async function fetchTopUsers() {
      try {
        // Get top mindfulness user
        const { data: mindfulnessData, error: mindfulnessError } = await supabase
          .from('user_stats')
          .select(`
            breathing_level, 
            total_breathing_sessions, 
            meditation_minutes, 
            focus_sessions, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order('breathing_level', { ascending: false })
          .limit(1)
          .single();
        
        if (mindfulnessError) {
          state.topMindfulnessUser = state.testUsers[0];
        } else if (mindfulnessData) {
          state.topMindfulnessUser = {
            username: mindfulnessData.user_profiles?.username || 'Anonymous',
            avatar_url: mindfulnessData.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
            breathing_level: mindfulnessData.breathing_level,
            total_breathing_sessions: mindfulnessData.total_breathing_sessions,
            meditation_minutes: mindfulnessData.meditation_minutes,
            focus_sessions: mindfulnessData.focus_sessions
          };
        }

        // Get top nutrition user
        const { data: nutritionData, error: nutritionError } = await supabase
          .from('nutrition_stats')
          .select(`
            correct_answers, 
            wrong_answers, 
            total_answers, 
            accuracy, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order('correct_answers', { ascending: false })
          .limit(1)
          .single();
        
        if (nutritionError) {
          state.topNutritionUser = state.testUsers[1];
        } else if (nutritionData) {
          state.topNutritionUser = {
            username: nutritionData.user_profiles?.username || 'Anonymous',
            avatar_url: nutritionData.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face',
            correct_answers: nutritionData.correct_answers,
            wrong_answers: nutritionData.wrong_answers,
            total_answers: nutritionData.total_answers,
            accuracy: nutritionData.accuracy
          };
        }
      } catch (error) {
        console.error('Error fetching top users:', error);
        // Fallback to test data
        state.topMindfulnessUser = state.testUsers[0];
        state.topNutritionUser = state.testUsers[1];
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      elements.mindfulnessBtn.addEventListener('click', () => {
        state.activeView = 'mindfulness';
        updateView();
        elements.mindfulnessBtn.classList.add('tab-active', 'text-blue-600');
        elements.mindfulnessBtn.classList.remove('text-slate-600');
        elements.nutritionBtn.classList.remove('tab-active', 'text-green-600');
        elements.nutritionBtn.classList.add('text-slate-600');
      });

      elements.nutritionBtn.addEventListener('click', () => {
        state.activeView = 'nutrition';
        updateView();
        elements.nutritionBtn.classList.add('tab-active', 'text-green-600');
        elements.nutritionBtn.classList.remove('text-slate-600');
        elements.mindfulnessBtn.classList.remove('tab-active', 'text-blue-600');
        elements.mindfulnessBtn.classList.add('text-slate-600');
      });
    }

    // Update the view based on state
    function updateView() {
      if (state.activeView === 'mindfulness') {
        elements.mindfulnessLeaderboard.classList.remove('hidden');
        elements.nutritionLeaderboard.classList.add('hidden');
        renderMindfulnessLeaderboard();
      } else {
        elements.mindfulnessLeaderboard.classList.add('hidden');
        elements.nutritionLeaderboard.classList.remove('hidden');
        renderNutritionLeaderboard();
      }
    }

    // Get rank icon
    function getRankIcon(rank) {
      switch(rank) {
        case 1: return '<div class="rank-badge rank-1"><i data-lucide="trophy" class="w-4 h-4"></i></div>';
        case 2: return '<div class="rank-badge rank-2"><i data-lucide="medal" class="w-4 h-4"></i></div>';
        case 3: return '<div class="rank-badge rank-3"><i data-lucide="award" class="w-4 h-4"></i></div>';
        default: return `<div class="rank-badge bg-gray-100 text-gray-600">${rank}</div>`;
      }
    }

    // Get rank background
    function getRankBg(rank) {
      switch(rank) {
        case 1: return 'bg-gradient-to-r from-yellow-50 to-yellow-100 border-yellow-200';
        case 2: return 'bg-gradient-to-r from-gray-50 to-gray-100 border-gray-200';
        case 3: return 'bg-gradient-to-r from-amber-50 to-amber-100 border-amber-200';
        default: return 'bg-white border-gray-200';
      }
    }

    // Show modal with term definitions
    function showTermsModal() {
      elements.termsModal.classList.remove('hidden');
    }

    // Close modal
    function closeModal() {
      elements.termsModal.classList.add('hidden');
    }

    // Show quiz modal
    function showQuizModal() {
      elements.quizModal.classList.remove('hidden');
      state.quizStartTime = Date.now();
      startQuiz();
    }

    // Close quiz modal
    function closeQuizModal() {
      elements.quizModal.classList.add('hidden');
      state.currentQuestion = 0;
      state.score = 0;
      state.selectedAnswer = null;
      state.quizStartTime = null;
      state.suspiciousActivity = 0;
      state.tabSwitchCount = 0;
    }

    // Start quiz function
    function startQuiz() {
      // Generate quiz questions
      const questions = [
        {
          question: "Which of these is a good source of protein?",
          options: ["Apple", "Chicken breast", "White bread", "Soda"],
          correctAnswer: 1
        },
        {
          question: "How many servings of vegetables should you eat daily?",
          options: ["1-2", "3-5", "6-8", "None"],
          correctAnswer: 1
        },
        {
          question: "Which vitamin is important for bone health?",
          options: ["Vitamin A", "Vitamin C", "Vitamin D", "Vitamin K"],
          correctAnswer: 2
        }
      ];
      
      state.quizQuestions = questions;
      state.currentQuestion = 0;
      state.score = 0;
      state.selectedAnswer = null;
      
      renderQuizQuestion();
    }

    // Render current quiz question
    function renderQuizQuestion() {
      if (state.currentQuestion >= state.quizQuestions.length) {
        showQuizResults();
        return;
      }
      
      const question = state.quizQuestions[state.currentQuestion];
      
      const html = `
        <div class="quiz-question">
          <h4 class="text-lg font-semibold mb-4">Question ${state.currentQuestion + 1}: ${question.question}</h4>
          <div class="space-y-3">
            ${question.options.map((option, index) => `
              <button 
                onclick="selectAnswer(${index})"
                class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors ${state.selectedAnswer === index ? 'bg-blue-50 border-blue-300' : ''}"
              >
                ${option}
              </button>
            `).join('')}
          </div>
          <button 
            onclick="submitAnswer()"
            class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors ${state.selectedAnswer === null ? 'opacity-50 cursor-not-allowed' : ''}"
            ${state.selectedAnswer === null ? 'disabled' : ''}
          >
            Submit Answer
          </button>
        </div>
      `;
      
      elements.quizContent.innerHTML = html;
    }

    // Submit answer
    function submitAnswer() {
      if (state.selectedAnswer === null) return;
      
      const question = state.quizQuestions[state.currentQuestion];
      if (state.selectedAnswer === question.correctAnswer) {
        state.score++;
      }
      
      state.currentQuestion++;
      state.selectedAnswer = null;
      renderQuizQuestion();
    }

    // Show quiz results
    function showQuizResults() {
      const html = `
        <div class="quiz-results text-center">
          <div class="mb-6">
            <i data-lucide="award" class="w-12 h-12 mx-auto text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Quiz Completed!</h3>
            <p class="text-gray-600">You scored ${state.score} out of ${state.quizQuestions.length}</p>
          </div>
          <button 
            onclick="closeQuizModal()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors"
          >
            Close
          </button>
        </div>
      `;
      
      elements.quizContent.innerHTML = html;
      lucide.createIcons();
      
      // Update user's score in the database
      if (state.currentUser) {
        updateUserScore(state.score);
      }
    }

    // Update user's score in the database
    async function updateUserScore(score) {
      try {
        // Get current stats
        const { data: currentStats, error: getError } = await supabase
          .from('nutrition_stats')
          .select('correct_answers, wrong_answers, total_answers')
          .eq('user_id', state.currentUser.id)
          .single();
        
        if (getError && getError.code !== 'PGRST116') { // Ignore "No rows found" error
          throw getError;
        }
        
        // Calculate new values
        const correctAnswers = (currentStats?.correct_answers || 0) + score;
        const wrongAnswers = (currentStats?.wrong_answers || 0) + (state.quizQuestions.length - score);
        const totalAnswers = (currentStats?.total_answers || 0) + state.quizQuestions.length;
        const accuracy = Math.round((correctAnswers / totalAnswers) * 100);
        
        // Upsert the data
        const { error: upsertError } = await supabase
          .from('nutrition_stats')
          .upsert({
            user_id: state.currentUser.id,
            correct_answers: correctAnswers,
            wrong_answers: wrongAnswers,
            total_answers: totalAnswers,
            accuracy: accuracy,
            updated_at: new Date().toISOString()
          });
        
        if (upsertError) throw upsertError;
        
        // Refresh leaderboard
        await fetchTopUsers();
        renderNutritionLeaderboard();
        
      } catch (error) {
        console.error('Error updating user score:', error);
      }
    }

    // Render mindfulness leaderboard
    async function renderMindfulnessLeaderboard() {
      try {
        // Fetch mindfulness data from Supabase
        const { data: mindfulnessData, error } = await supabase
          .from('user_stats')
          .select(`
            breathing_level, 
            total_breathing_sessions, 
            meditation_minutes, 
            focus_sessions, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order('breathing_level', { ascending: false })
          .limit(10);
        
        let currentData = [];
        
        if (error) {
          // Create test leaderboard data
          currentData = Array.from({ length: 5 }, (_, i) => ({
            user_profiles: {
              username: `MindfulUser${i+1}`,
              avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face'
            },
            breathing_level: 10 - i,
            total_breathing_sessions: 35 - (i * 5),
            meditation_minutes: 1000 - (i * 100),
            focus_sessions: 50 - (i * 5)
          }));
          
          // Add our top test user
          currentData.unshift({
            user_profiles: {
              username: state.testUsers[0].username,
              avatar_url: state.testUsers[0].avatar_url
            },
            breathing_level: state.testUsers[0].breathing_level,
            total_breathing_sessions: state.testUsers[0].total_breathing_sessions,
            meditation_minutes: state.testUsers[0].meditation_minutes,
            focus_sessions: state.testUsers[0].focus_sessions
          });
        } else {
          currentData = mindfulnessData || [];
        }
        
        const html = `
          <div class="space-y-6">
            <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
              <button
                onclick="state.activeMindfulnessTab = 'breathing'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'breathing' 
                    ? 'tab-active text-blue-600' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="brain" class="w-4 h-4 inline mr-2 tab-icon"></i>
                <span onclick="showTermsModal()" class="cursor-help hover:underline">Breathing Level</span>
              </button>
              <button
                onclick="state.activeMindfulnessTab = 'meditation'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'meditation' 
                    ? 'tab-active text-blue-600' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="moon" class="w-4 h-4 inline mr-2 tab-icon"></i>
                <span onclick="showTermsModal()" class="cursor-help hover:underline">Meditation</span>
              </button>
              <button
                onclick="state.activeMindfulnessTab = 'focus'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'focus' 
                    ? 'tab-active text-blue-600' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="target" class="w-4 h-4 inline mr-2 tab-icon"></i>
                <span onclick="showTermsModal()" class="cursor-help hover:underline">Focus Sessions</span>
              </button>
            </div>

            <div class="leaderboard-card rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                  <i data-lucide="brain" class="w-6 h-6 text-blue-600"></i>
                  <h3 class="text-xl font-semibold text-gray-900 font-playfair">üßò‚Äç‚ôÄÔ∏è Monk-ness LeaderBoard</h3>
                </div>
              </div>
              
              <div class="divide-y divide-gray-200">
                ${currentData.map((user, index) => `
                  <div class="flex items-center justify-between p-4 ${getRankBg(index + 1)}">
                    <div class="flex items-center space-x-4">
                      ${getRankIcon(index + 1)}
                      <img 
                        src="${user.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face'}" 
                        alt="${user.user_profiles?.username || 'Anonymous'}"
                        class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm user-avatar"
                      />
                      <div>
                        <h4 class="font-semibold text-gray-900">${user.user_profiles?.username || 'Anonymous User'}</h4>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-600">
                          <span class="flex items-center">
                            <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                            ${user.total_breathing_sessions || 0} sessions
                          </span>
                          ${state.activeMindfulnessTab === 'meditation' ? `
                            <span class="flex items-center">
                              <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                              ${user.meditation_minutes || 0} mins
                            </span>
                          ` : ''}
                          ${state.activeMindfulnessTab === 'focus' ? `
                            <span class="flex items-center">
                              <i data-lucide="target" class="w-4 h-4 mr-1"></i>
                              ${user.focus_sessions || 0} sessions
                            </span>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                    
                    <div class="text-right">
                      <div class="text-2xl font-bold text-gray-900">
                        ${state.activeMindfulnessTab === 'breathing' ? user.breathing_level || 1 :
                          state.activeMindfulnessTab === 'meditation' ? user.meditation_minutes || 0 :
                          user.focus_sessions || 0}
                      </div>
                      <div class="text-sm text-gray-500">
                        ${state.activeMindfulnessTab === 'breathing' ? 'Level' :
                          state.activeMindfulnessTab === 'meditation' ? 'Minutes' :
                          'Sessions'}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        elements.mindfulnessLeaderboard.innerHTML = html;
        lucide.createIcons();
      } catch (error) {
        console.error('Error rendering mindfulness leaderboard:', error);
        elements.mindfulnessLeaderboard.innerHTML = `
          <div class="leaderboard-card rounded-xl shadow-sm border border-gray-200 p-8 text-center">
            <div class="text-gray-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">Error loading data</h3>
              <p class="text-sm">Please check your connection and try again.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Render nutrition leaderboard
    async function renderNutritionLeaderboard() {
      try {
        // Fetch nutrition data from Supabase
        const { data: nutritionData, error } = await supabase
          .from('nutrition_stats')
          .select(`
            correct_answers, 
            wrong_answers, 
            total_answers, 
            accuracy, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order(state.activeNutritionTab === 'correct' ? 'correct_answers' : 
                state.activeNutritionTab === 'wrong' ? 'wrong_answers' : 'total_answers', 
                { ascending: false })
          .limit(10);
        
        let currentData = [];
        
        if (error) {
          // Create test leaderboard data
          currentData = Array.from({ length: 5 }, (_, i) => ({
            user_profiles: {
              username: `NutritionUser${i+1}`,
              avatar_url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face'
            },
            correct_answers: 25 - (i * 3),
            wrong_answers: 5 + i,
            total_answers: 30 - (i * 2),
            accuracy: 80 - (i * 5)
          }));
          
          // Add our top test user
          currentData.unshift({
            user_profiles: {
              username: state.testUsers[1].username,
              avatar_url: state.testUsers[1].avatar_url
            },
            correct_answers: state.testUsers[1].correct_answers,
            wrong_answers: state.testUsers[1].wrong_answers,
            total_answers: state.testUsers[1].total_answers,
            accuracy: state.testUsers[1].accuracy
          });
        } else {
          currentData = nutritionData || [];
        }
        
        let title, icon, valueKey, valueLabel;
        
        switch(state.activeNutritionTab) {
          case 'correct':
            title = 'Most Correct Answers';
            icon = '<i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>';
            valueKey = 'correct_answers';
            valueLabel = 'correct';
            break;
          case 'wrong':
            title = 'Most Wrong Answers';
            icon = '<i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>';
            valueKey = 'wrong_answers';
            valueLabel = 'wrong';
            break;
          case 'total':
            title = 'Most Active Learners';
            icon = '<i data-lucide="users" class="w-6 h-6 text-blue-600"></i>';
            valueKey = 'total_answers';
            valueLabel = 'total';
            break;
        }

        const html = `
          <div class="space-y-6">
            <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
              <button
                onclick="state.activeNutritionTab = 'correct'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'correct' 
                    ? 'tab-active text-green-600' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="check-circle" class="w-4 h-4 inline mr-1 tab-icon"></i>
                <span class="tab-text">Most Correct</span>
              </button>
              <button
                onclick="state.activeNutritionTab = 'wrong'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'wrong' 
                    ? 'tab-active text-red-600' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="x-circle" class="w-4 h-4 inline mr-1 tab-icon"></i>
                <span class="tab-text">Most Wrong</span>
              </button>
              <button
                onclick="state.activeNutritionTab = 'total'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'total' 
                    ? 'tab-active text-blue-600' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="users" class="w-4 h-4 inline mr-1 tab-icon"></i>
                <span class="tab-text">Most Active</span>
              </button>
            </div>

            <div class="leaderboard-card rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  ${icon}
                  <h3 class="text-xl font-semibold text-gray-900 font-playfair">ü•ó Nutri Board - ${title}</h3>
                </div>
                <button
                  onclick="showQuizModal()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2"
                >
                  <i data-lucide="play" class="w-4 h-4"></i>
                  <span>Take Quiz</span>
                </button>
              </div>
              
              <div class="divide-y divide-gray-200">
                ${currentData.map((user, index) => `
                  <div class="flex items-center justify-between p-4 ${getRankBg(index + 1)}">
                    <div class="flex items-center space-x-4">
                      ${getRankIcon(index + 1)}
                      <img 
                        src="${user.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face'}" 
                        alt="${user.user_profiles?.username || 'Anonymous'}"
                        class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm user-avatar"
                      />
                      <div>
                        <h4 class="font-semibold text-gray-900">${user.user_profiles?.username || 'Anonymous User'}</h4>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-600">
                          <span class="text-green-600">‚úì ${user.correct_answers || 0}</span>
                          <span class="text-red-600">‚úó ${user.wrong_answers || 0}</span>
                          <span class="text-blue-600">${user.accuracy || 0}% accuracy</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="text-right">
                      <div class="text-2xl font-bold text-gray-900">
                        ${user[valueKey] || 0}
                      </div>
                      <div class="text-sm text-gray-500">
                        ${valueLabel}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        elements.nutritionLeaderboard.innerHTML = html;
        lucide.createIcons();
      } catch (error) {
        console.error('Error rendering nutrition leaderboard:', error);
        elements.nutritionLeaderboard.innerHTML = `
          <div class="leaderboard-card rounded-xl shadow-sm border border-gray-200 p-8 text-center">
            <div class="text-gray-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">Error loading data</h3>
              <p class="text-sm">Please check your connection and try again.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Initialize the app
    init();

    // Make functions available globally
    window.startQuiz = startQuiz;
    window.showQuizModal = showQuizModal;
    window.closeQuizModal = closeQuizModal;
    window.selectAnswer = selectAnswer;
    window.submitAnswer = submitAnswer;
    window.showTermsModal = showTermsModal;
    window.closeModal = closeModal;
    window.state = state;
  </script>
</body>
</html>
