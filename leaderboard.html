<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Leaderboards</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    .select-none {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    @keyframes fadeInOut {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .fade-animation {
      animation: fadeInOut 3s ease-in-out infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-slate-900 mb-2">Community Leaderboards</h1>
      <p class="text-lg text-slate-600">Compete with fellow learners and track your progress</p>
    </div>

    <!-- Main Navigation -->
    <div class="flex justify-center mb-8">
      <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
        <button
          id="mindfulnessBtn"
          class="py-3 px-6 rounded-md font-medium transition-colors bg-white text-blue-600 shadow-sm"
        >
          üßò‚Äç‚ôÄÔ∏è Monk-ness LeaderBoard
        </button>
        <button
          id="nutritionBtn"
          class="py-3 px-6 rounded-md font-medium transition-colors text-slate-600 hover:text-slate-900"
        >
          ü•ó Nutri Board
        </button>
      </div>
    </div>

    <!-- Leaderboard Content -->
    <div id="mindfulnessLeaderboard"></div>
    <div id="nutritionLeaderboard" class="hidden"></div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Supabase configuration
    const SUPABASE_URL = 'https://fhthwxgkxuontprzclhb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZodGh3eGdreHVvbnRwcnpjbGhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDczNDgsImV4cCI6MjA2OTYyMzM0OH0.9mEHL1jpYXkMeWg0UNKK5LYPosj0eou4k-mw3eof-ZU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // OpenRouter configuration
    const OPENROUTER_API_KEY = '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';
    
    // App state
    const state = {
      activeView: 'mindfulness',
      activeMindfulnessTab: 'breathing',
      activeNutritionTab: 'correct',
      showQuiz: false,
      currentQuestion: 0,
      selectedAnswer: null,
      showResult: false,
      score: 0,
      userGrade: 'middle',
      quizQuestions: [],
      isGeneratingQuiz: false,
      isScreenBlocked: false,
      suspiciousActivity: 0,
      quizStartTime: null,
      tabSwitchCount: 0,
      isWindowFocused: true,
      currentUser: null,
      topMindfulnessUser: null,
      topNutritionUser: null,
      testUsers: [
        {
          id: '11111111-1111-1111-1111-111111111111',
          username: 'MindfulMaster',
          avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
          breathing_level: 15,
          total_breathing_sessions: 42
        },
        {
          id: '22222222-2222-2222-2222-222222222222',
          username: 'NutritionNinja',
          avatar_url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face',
          correct_answers: 38,
          wrong_answers: 5,
          total_answers: 43,
          accuracy: 88
        }
      ]
    };

    // DOM elements
    const elements = {
      mindfulnessBtn: document.getElementById('mindfulnessBtn'),
      nutritionBtn: document.getElementById('nutritionBtn'),
      mindfulnessLeaderboard: document.getElementById('mindfulnessLeaderboard'),
      nutritionLeaderboard: document.getElementById('nutritionLeaderboard')
    };

    // Initialize the app
    async function init() {
      try {
        console.log('Initializing app...');
        await checkAuth();
        await fetchTopUsers();
        renderMindfulnessLeaderboard();
        setupEventListeners();
        console.log('App initialized successfully');
      } catch (error) {
        console.error('Error initializing app:', error);
        // Continue with test data
        state.topMindfulnessUser = state.testUsers[0];
        state.topNutritionUser = state.testUsers[1];
        renderMindfulnessLeaderboard();
        setupEventListeners();
      }
    }

    // Check authentication
    async function checkAuth() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) {
          console.log('No authenticated user, continuing with test data');
          return;
        }
        
        if (!user) {
          console.log('No user found, continuing with test data');
          return;
        }
        
        state.currentUser = user;
        console.log('User authenticated:', user.email);
        
        // Get user's grade level
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('grade_level')
          .eq('id', user.id)
          .single();
        
        if (profile && profile.grade_level) {
          state.userGrade = profile.grade_level.toLowerCase().replace('th', '').replace(' grade', '');
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }

    // Fetch top users for each leaderboard
    async function fetchTopUsers() {
      try {
        console.log('Fetching top users...');
        
        // Get top mindfulness user
        const { data: mindfulnessData, error: mindfulnessError } = await supabase
          .from('user_stats')
          .select('breathing_level, total_breathing_sessions, user_id, user_profiles(username, avatar_url)')
          .order('breathing_level', { ascending: false })
          .limit(1)
          .single();
        
        if (mindfulnessError) {
          console.log('Using test mindfulness data due to error:', mindfulnessError);
          state.topMindfulnessUser = state.testUsers[0];
        } else if (mindfulnessData) {
          state.topMindfulnessUser = {
            username: mindfulnessData.user_profiles?.username || 'Anonymous',
            avatar_url: mindfulnessData.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
            breathing_level: mindfulnessData.breathing_level,
            total_breathing_sessions: mindfulnessData.total_breathing_sessions
          };
        }

        // Get top nutrition user
        const { data: nutritionData, error: nutritionError } = await supabase
          .from('nutrition_stats')
          .select('correct_answers, wrong_answers, total_answers, accuracy, user_id, user_profiles(username, avatar_url)')
          .order('correct_answers', { ascending: false })
          .limit(1)
          .single();
        
        if (nutritionError) {
          console.log('Using test nutrition data due to error:', nutritionError);
          state.topNutritionUser = state.testUsers[1];
        } else if (nutritionData) {
          state.topNutritionUser = {
            username: nutritionData.user_profiles?.username || 'Anonymous',
            avatar_url: nutritionData.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face',
            correct_answers: nutritionData.correct_answers,
            wrong_answers: nutritionData.wrong_answers,
            total_answers: nutritionData.total_answers,
            accuracy: nutritionData.accuracy
          };
        }
        
        console.log('Top users fetched successfully');
      } catch (error) {
        console.error('Error fetching top users:', error);
        // Fallback to test data
        state.topMindfulnessUser = state.testUsers[0];
        state.topNutritionUser = state.testUsers[1];
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      elements.mindfulnessBtn.addEventListener('click', () => {
        state.activeView = 'mindfulness';
        updateView();
        elements.mindfulnessBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
        elements.mindfulnessBtn.classList.remove('text-slate-600', 'hover:text-slate-900');
        elements.nutritionBtn.classList.remove('bg-white', 'text-green-600', 'shadow-sm');
        elements.nutritionBtn.classList.add('text-slate-600', 'hover:text-slate-900');
      });

      elements.nutritionBtn.addEventListener('click', () => {
        state.activeView = 'nutrition';
        updateView();
        elements.nutritionBtn.classList.add('bg-white', 'text-green-600', 'shadow-sm');
        elements.nutritionBtn.classList.remove('text-slate-600', 'hover:text-slate-900');
        elements.mindfulnessBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
        elements.mindfulnessBtn.classList.add('text-slate-600', 'hover:text-slate-900');
      });
    }

    // Update the view based on state
    function updateView() {
      if (state.activeView === 'mindfulness') {
        elements.mindfulnessLeaderboard.classList.remove('hidden');
        elements.nutritionLeaderboard.classList.add('hidden');
        renderMindfulnessLeaderboard();
      } else {
        elements.mindfulnessLeaderboard.classList.add('hidden');
        elements.nutritionLeaderboard.classList.remove('hidden');
        renderNutritionLeaderboard();
      }
    }

    // Get rank icon
    function getRankIcon(rank) {
      switch(rank) {
        case 1: return '<i data-lucide="trophy" class="w-6 h-6 text-yellow-500"></i>';
        case 2: return '<i data-lucide="medal" class="w-6 h-6 text-gray-400"></i>';
        case 3: return '<i data-lucide="award" class="w-6 h-6 text-amber-600"></i>';
        default: return `<div class="w-6 h-6 bg-slate-300 rounded-full flex items-center justify-center text-xs font-bold text-slate-600">${rank}</div>`;
      }
    }

    // Get rank background
    function getRankBg(rank) {
      switch(rank) {
        case 1: return 'bg-gradient-to-r from-yellow-50 to-yellow-100 border-yellow-200';
        case 2: return 'bg-gradient-to-r from-gray-50 to-gray-100 border-gray-200';
        case 3: return 'bg-gradient-to-r from-amber-50 to-amber-100 border-amber-200';
        default: return 'bg-white border-slate-200';
      }
    }

    // Render mindfulness leaderboard
    async function renderMindfulnessLeaderboard() {
      console.log('Rendering mindfulness leaderboard...');
      
      try {
        // Fetch mindfulness data from Supabase
        const { data: mindfulnessData, error } = await supabase
          .from('user_stats')
          .select('breathing_level, total_breathing_sessions, user_id, user_profiles(username, avatar_url)')
          .order('breathing_level', { ascending: false })
          .limit(10);
        
        let currentData = [];
        
        if (error) {
          console.log('Using test mindfulness data due to error:', error);
          // Create test leaderboard data
          currentData = Array.from({ length: 5 }, (_, i) => ({
            user_profiles: {
              username: `MindfulUser${i+1}`,
              avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face'
            },
            breathing_level: 10 - i,
            total_breathing_sessions: 35 - (i * 5)
          }));
          
          // Add our top test user
          currentData.unshift({
            user_profiles: {
              username: state.testUsers[0].username,
              avatar_url: state.testUsers[0].avatar_url
            },
            breathing_level: state.testUsers[0].breathing_level,
            total_breathing_sessions: state.testUsers[0].total_breathing_sessions
          });
        } else {
          currentData = mindfulnessData || [];
        }
        
        const html = `
          <div class="space-y-6">
            <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
              <button
                onclick="state.activeMindfulnessTab = 'breathing'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'breathing' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="brain" class="w-4 h-4 inline mr-2"></i>
                Breathing Level
              </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200">
              <div class="p-6 border-b border-slate-200">
                <div class="flex items-center space-x-2">
                  <i data-lucide="brain" class="w-5 h-5"></i>
                  <h3 class="text-lg font-semibold text-slate-900">Top Breathing Masters</h3>
                </div>
              </div>
              
              <div class="p-6">
                <div class="space-y-4">
                  ${currentData.map((user, index) => `
                    <div key="${user.user_profiles?.username || 'anonymous'}" class="flex items-center justify-between p-4 rounded-lg border-2 ${getRankBg(index + 1)}">
                      <div class="flex items-center space-x-4">
                        ${getRankIcon(index + 1)}
                        <img 
                          src="${user.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face'}" 
                          alt="${user.user_profiles?.username || 'Anonymous'}"
                          class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm"
                        />
                        <div>
                          <h4 class="font-semibold text-slate-900">${user.user_profiles?.username || 'Anonymous User'}</h4>
                          <div class="flex items-center space-x-4 text-sm text-slate-600">
                            <span class="flex items-center">
                              <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                              ${user.total_breathing_sessions || 0} sessions
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <div class="text-right">
                        <div class="text-2xl font-bold text-slate-900">
                          ${user.breathing_level || 1}
                        </div>
                        <div class="text-sm text-slate-500">
                          Level
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;

        elements.mindfulnessLeaderboard.innerHTML = html;
        lucide.createIcons();
        console.log('Mindfulness leaderboard rendered successfully');
      } catch (error) {
        console.error('Error rendering mindfulness leaderboard:', error);
        elements.mindfulnessLeaderboard.innerHTML = `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
            <div class="text-slate-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">Error loading data</h3>
              <p class="text-sm">Please check your connection and try again.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Render nutrition leaderboard
    async function renderNutritionLeaderboard() {
      console.log('Rendering nutrition leaderboard...');
      
      try {
        // Fetch nutrition data from Supabase
        const { data: nutritionData, error } = await supabase
          .from('nutrition_stats')
          .select('correct_answers, wrong_answers, total_answers, accuracy, user_id, user_profiles(username, avatar_url)')
          .order(state.activeNutritionTab === 'correct' ? 'correct_answers' : 
                state.activeNutritionTab === 'wrong' ? 'wrong_answers' : 'total_answers', 
                { ascending: false })
          .limit(10);
        
        let currentData = [];
        
        if (error) {
          console.log('Using test nutrition data due to error:', error);
          // Create test leaderboard data
          currentData = Array.from({ length: 5 }, (_, i) => ({
            user_profiles: {
              username: `NutritionUser${i+1}`,
              avatar_url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face'
            },
            correct_answers: 25 - (i * 3),
            wrong_answers: 5 + i,
            total_answers: 30 - (i * 2),
            accuracy: 80 - (i * 5)
          }));
          
          // Add our top test user
          currentData.unshift({
            user_profiles: {
              username: state.testUsers[1].username,
              avatar_url: state.testUsers[1].avatar_url
            },
            correct_answers: state.testUsers[1].correct_answers,
            wrong_answers: state.testUsers[1].wrong_answers,
            total_answers: state.testUsers[1].total_answers,
            accuracy: state.testUsers[1].accuracy
          });
        } else {
          currentData = nutritionData || [];
        }
        
        let title, icon, valueKey, valueLabel;
        
        switch(state.activeNutritionTab) {
          case 'correct':
            title = 'Most Correct Answers';
            icon = '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>';
            valueKey = 'correct_answers';
            valueLabel = 'correct';
            break;
          case 'wrong':
            title = 'Most Wrong Answers';
            icon = '<i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>';
            valueKey = 'wrong_answers';
            valueLabel = 'wrong';
            break;
          case 'total':
            title = 'Most Active Learners';
            icon = '<i data-lucide="users" class="w-5 h-5 text-blue-600"></i>';
            valueKey = 'total_answers';
            valueLabel = 'total';
            break;
        }

        const html = `
          <div class="space-y-6">
            <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
              <button
                onclick="state.activeNutritionTab = 'correct'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'correct' 
                    ? 'bg-white text-green-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                Most Correct
              </button>
              <button
                onclick="state.activeNutritionTab = 'wrong'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'wrong' 
                    ? 'bg-white text-red-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="x-circle" class="w-4 h-4 inline mr-1"></i>
                Most Wrong
              </button>
              <button
                onclick="state.activeNutritionTab = 'total'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'total' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                Most Active
              </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200">
              <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  ${icon}
                  <h3 class="text-lg font-semibold text-slate-900">${title}</h3>
                </div>
                <button
                  onclick="startQuiz()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2"
                >
                  <i data-lucide="play" class="w-4 h-4"></i>
                  <span>Take Quiz</span>
                </button>
              </div>
              
              <div class="p-6">
                <div class="space-y-4">
                  ${currentData.map((user, index) => `
                    <div key="${user.user_profiles?.username || 'anonymous'}" class="flex items-center justify-between p-4 rounded-lg border-2 ${getRankBg(index + 1)}">
                      <div class="flex items-center space-x-4">
                        ${getRankIcon(index + 1)}
                        <img 
                          src="${user.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face'}" 
                          alt="${user.user_profiles?.username || 'Anonymous'}"
                          class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm"
                        />
                        <div>
                          <h4 class="font-semibold text-slate-900">${user.user_profiles?.username || 'Anonymous User'}</h4>
                          <div class="flex items-center space-x-4 text-sm text-slate-600">
                            <span class="text-green-600">‚úì ${user.correct_answers || 0}</span>
                            <span class="text-red-600">‚úó ${user.wrong_answers || 0}</span>
                            <span class="text-blue-600">${user.accuracy || 0}% accuracy</span>
                          </div>
                        </div>
                      </div>
                      
                      <div class="text-right">
                        <div class="text-2xl font-bold text-slate-900">
                          ${user[valueKey] || 0}
                        </div>
                        <div class="text-sm text-slate-500">
                          ${valueLabel}
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;

        elements.nutritionLeaderboard.innerHTML = html;
        lucide.createIcons();
        console.log('Nutrition leaderboard rendered successfully');
      } catch (error) {
        console.error('Error rendering nutrition leaderboard:', error);
        elements.nutritionLeaderboard.innerHTML = `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
            <div class="text-slate-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">Error loading data</h3>
              <p class="text-sm">Please check your connection and try again.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Initialize the app
    init();

    // Make functions available globally
    window.startQuiz = startQuiz;
    window.state = state;
  </script>
</body>
</html>
