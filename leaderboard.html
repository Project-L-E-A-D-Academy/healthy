<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Leaderboards</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    .select-none {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    @keyframes fadeInOut {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .fade-animation {
      animation: fadeInOut 3s ease-in-out infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-slate-900 mb-2">Community Leaderboards</h1>
      <p class="text-lg text-slate-600">Compete with fellow learners and track your progress</p>
    </div>

    <!-- Main Navigation -->
    <div class="flex justify-center mb-8">
      <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
        <button
          id="mindfulnessBtn"
          class="py-3 px-6 rounded-md font-medium transition-colors bg-white text-blue-600 shadow-sm"
        >
          üßò‚Äç‚ôÄÔ∏è Monk-ness LeaderBoard
        </button>
        <button
          id="nutritionBtn"
          class="py-3 px-6 rounded-md font-medium transition-colors text-slate-600 hover:text-slate-900"
        >
          ü•ó Nutri Board
        </button>
      </div>
    </div>

    <!-- Leaderboard Content -->
    <div id="mindfulnessLeaderboard"></div>
    <div id="nutritionLeaderboard" class="hidden"></div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Supabase configuration
    const SUPABASE_URL = 'https://fhthwxgkxuontprzclhb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZodGh3eGdreHVvbnRwcnpjbGhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDczNDgsImV4cCI6MjA2OTYyMzM0OH0.9mEHL1jpYXkMeWg0UNKK5LYPosj0eou4k-mw3eof-ZU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // OpenRouter configuration
    const OPENROUTER_API_KEY = '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';
    
    // App state
    const state = {
      activeView: 'mindfulness',
      activeMindfulnessTab: 'breathing',
      activeNutritionTab: 'correct',
      showQuiz: false,
      currentQuestion: 0,
      selectedAnswer: null,
      showResult: false,
      score: 0,
      userGrade: 'middle',
      quizQuestions: [],
      isGeneratingQuiz: false,
      isScreenBlocked: false,
      suspiciousActivity: 0,
      quizStartTime: null,
      tabSwitchCount: 0,
      isWindowFocused: true,
      currentUser: null,
      topMindfulnessUser: null,
      topNutritionUser: null,
      testUsers: [
        {
          id: '11111111-1111-1111-1111-111111111111',
          username: 'MindfulMaster',
          avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
          breathing_level: 15,
          total_breathing_sessions: 42,
          meditation_minutes: 1200,
          focus_sessions: 85
        },
        {
          id: '22222222-2222-2222-2222-222222222222',
          username: 'NutritionNinja',
          avatar_url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face',
          correct_answers: 38,
          wrong_answers: 5,
          total_answers: 43,
          accuracy: 88
        }
      ]
    };

    // DOM elements
    const elements = {
      mindfulnessBtn: document.getElementById('mindfulnessBtn'),
      nutritionBtn: document.getElementById('nutritionBtn'),
      mindfulnessLeaderboard: document.getElementById('mindfulnessLeaderboard'),
      nutritionLeaderboard: document.getElementById('nutritionLeaderboard')
    };

    // Initialize the app
    async function init() {
      try {
        console.log('Initializing app...');
        await checkAuth();
        await fetchTopUsers();
        renderMindfulnessLeaderboard();
        setupEventListeners();
        console.log('App initialized successfully');
      } catch (error) {
        console.error('Error initializing app:', error);
        // Continue with test data
        state.topMindfulnessUser = state.testUsers[0];
        state.topNutritionUser = state.testUsers[1];
        renderMindfulnessLeaderboard();
        setupEventListeners();
      }
    }

    // Check authentication
    async function checkAuth() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) {
          console.log('No authenticated user, continuing with test data');
          return;
        }
        
        if (!user) {
          console.log('No user found, continuing with test data');
          return;
        }
        
        state.currentUser = user;
        console.log('User authenticated:', user.email);
        
        // Get user's grade level
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('grade_level')
          .eq('id', user.id)
          .single();
        
        if (profile && profile.grade_level) {
          state.userGrade = profile.grade_level.toLowerCase().replace('th', '').replace(' grade', '');
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }

    // Fetch top users for each leaderboard
    async function fetchTopUsers() {
      try {
        console.log('Fetching top users...');
        
        // Get top mindfulness user
        const { data: mindfulnessData, error: mindfulnessError } = await supabase
          .from('user_stats')
          .select(`
            breathing_level, 
            total_breathing_sessions, 
            meditation_minutes, 
            focus_sessions, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order('breathing_level', { ascending: false })
          .limit(1)
          .single();
        
        if (mindfulnessError) {
          console.log('Using test mindfulness data due to error:', mindfulnessError);
          state.topMindfulnessUser = state.testUsers[0];
        } else if (mindfulnessData) {
          state.topMindfulnessUser = {
            username: mindfulnessData.user_profiles?.username || 'Anonymous',
            avatar_url: mindfulnessData.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face',
            breathing_level: mindfulnessData.breathing_level,
            total_breathing_sessions: mindfulnessData.total_breathing_sessions,
            meditation_minutes: mindfulnessData.meditation_minutes,
            focus_sessions: mindfulnessData.focus_sessions
          };
        }

        // Get top nutrition user
        const { data: nutritionData, error: nutritionError } = await supabase
          .from('nutrition_stats')
          .select(`
            correct_answers, 
            wrong_answers, 
            total_answers, 
            accuracy, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order('correct_answers', { ascending: false })
          .limit(1)
          .single();
        
        if (nutritionError) {
          console.log('Using test nutrition data due to error:', nutritionError);
          state.topNutritionUser = state.testUsers[1];
        } else if (nutritionData) {
          state.topNutritionUser = {
            username: nutritionData.user_profiles?.username || 'Anonymous',
            avatar_url: nutritionData.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face',
            correct_answers: nutritionData.correct_answers,
            wrong_answers: nutritionData.wrong_answers,
            total_answers: nutritionData.total_answers,
            accuracy: nutritionData.accuracy
          };
        }
        
        console.log('Top users fetched successfully');
      } catch (error) {
        console.error('Error fetching top users:', error);
        // Fallback to test data
        state.topMindfulnessUser = state.testUsers[0];
        state.topNutritionUser = state.testUsers[1];
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      elements.mindfulnessBtn.addEventListener('click', () => {
        state.activeView = 'mindfulness';
        updateView();
        elements.mindfulnessBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
        elements.mindfulnessBtn.classList.remove('text-slate-600', 'hover:text-slate-900');
        elements.nutritionBtn.classList.remove('bg-white', 'text-green-600', 'shadow-sm');
        elements.nutritionBtn.classList.add('text-slate-600', 'hover:text-slate-900');
      });

      elements.nutritionBtn.addEventListener('click', () => {
        state.activeView = 'nutrition';
        updateView();
        elements.nutritionBtn.classList.add('bg-white', 'text-green-600', 'shadow-sm');
        elements.nutritionBtn.classList.remove('text-slate-600', 'hover:text-slate-900');
        elements.mindfulnessBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
        elements.mindfulnessBtn.classList.add('text-slate-600', 'hover:text-slate-900');
      });
    }

    // Update the view based on state
    function updateView() {
      if (state.activeView === 'mindfulness') {
        elements.mindfulnessLeaderboard.classList.remove('hidden');
        elements.nutritionLeaderboard.classList.add('hidden');
        renderMindfulnessLeaderboard();
      } else {
        elements.mindfulnessLeaderboard.classList.add('hidden');
        elements.nutritionLeaderboard.classList.remove('hidden');
        renderNutritionLeaderboard();
      }
    }

    // Get rank icon
    function getRankIcon(rank) {
      switch(rank) {
        case 1: return '<i data-lucide="trophy" class="w-6 h-6 text-yellow-500"></i>';
        case 2: return '<i data-lucide="medal" class="w-6 h-6 text-gray-400"></i>';
        case 3: return '<i data-lucide="award" class="w-6 h-6 text-amber-600"></i>';
        default: return `<div class="w-6 h-6 bg-slate-300 rounded-full flex items-center justify-center text-xs font-bold text-slate-600">${rank}</div>`;
      }
    }

    // Get rank background
    function getRankBg(rank) {
      switch(rank) {
        case 1: return 'bg-gradient-to-r from-yellow-50 to-yellow-100 border-yellow-200';
        case 2: return 'bg-gradient-to-r from-gray-50 to-gray-100 border-gray-200';
        case 3: return 'bg-gradient-to-r from-amber-50 to-amber-100 border-amber-200';
        default: return 'bg-white border-slate-200';
      }
    }

    // Reset anti-cheat states
    function resetAntiCheatStates() {
      state.suspiciousActivity = 0;
      state.tabSwitchCount = 0;
      state.isScreenBlocked = false;
      state.quizStartTime = null;
      state.isWindowFocused = true;
    }

    // Generate quiz questions using OpenAI
    async function generateQuizQuestions() {
      state.isGeneratingQuiz = true;
      renderQuiz();
      
      try {
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
            'HTTP-Referer': 'https://project-l-e-a-d-academy.github.io',
            'X-Title': 'LEAD Nutrition Quiz',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'deepseek/deepseek-r1-0528:free',
            messages: [{
              role: 'system',
              content: `You are a nutrition quiz generator for ${state.userGrade}th grade students. Create engaging, creative questions that test knowledge of healthy eating, food groups, and nutrition. Each question should have 4 options and include an explanation. Format your response as JSON with question, options, correct (0-3 index), and explanation.`
            }, {
              role: 'user',
              content: `Generate 5 creative nutrition questions appropriate for ${state.userGrade}th grade level.`
            }],
            response_format: { type: 'json_object' }
          })
        });

        if (!response.ok) {
          throw new Error('Failed to generate quiz');
        }

        const data = await response.json();
        const questions = JSON.parse(data.choices[0].message.content).questions;
        
        // Ensure we have valid questions
        if (Array.isArray(questions)) {
          state.quizQuestions = questions.slice(0, 5);
        } else {
          // Fallback to sample questions if API fails
          const gradeQuestions = sampleQuestions[state.userGrade] || sampleQuestions.middle;
          const shuffled = [...gradeQuestions].sort(() => Math.random() - 0.5);
          state.quizQuestions = shuffled.slice(0, 5);
        }
      } catch (error) {
        console.error('Error generating quiz:', error);
        // Fallback to sample questions
        const gradeQuestions = sampleQuestions[state.userGrade] || sampleQuestions.middle;
        const shuffled = [...gradeQuestions].sort(() => Math.random() - 0.5);
        state.quizQuestions = shuffled.slice(0, 5);
      }
      
      state.isGeneratingQuiz = false;
      renderQuiz();
    }

    // Sample nutrition questions by grade level (fallback)
    const sampleQuestions = {
      elementary: [
        {
          question: "Which food group helps build strong bones and teeth?",
          options: ["Fruits", "Dairy", "Grains", "Vegetables"],
          correct: 1,
          explanation: "Dairy products like milk and cheese are rich in calcium, which helps build strong bones and teeth."
        },
        {
          question: "How many food groups are there in a healthy diet?",
          options: ["3", "4", "5", "6"],
          correct: 2,
          explanation: "There are 5 main food groups: fruits, vegetables, grains, protein, and dairy."
        }
      ],
      middle: [
        {
          question: "What is the recommended daily intake of water for teenagers?",
          options: ["4-6 cups", "6-8 cups", "8-10 cups", "10-12 cups"],
          correct: 2,
          explanation: "Teenagers should drink 8-10 cups of water daily to stay properly hydrated."
        },
        {
          question: "Which nutrient is the body's main source of energy?",
          options: ["Protein", "Fat", "Carbohydrates", "Vitamins"],
          correct: 2,
          explanation: "Carbohydrates are the body's preferred source of energy for daily activities."
        }
      ],
      high: [
        {
          question: "What is the difference between saturated and unsaturated fats?",
          options: [
            "Saturated fats are liquid at room temperature",
            "Unsaturated fats are solid at room temperature", 
            "Saturated fats are solid at room temperature",
            "There is no difference"
          ],
          correct: 2,
          explanation: "Saturated fats are typically solid at room temperature (like butter), while unsaturated fats are liquid (like olive oil)."
        }
      ]
    };

    // Start quiz
    function startQuiz() {
      state.showQuiz = true;
      state.currentQuestion = 0;
      state.score = 0;
      state.selectedAnswer = null;
      state.showResult = false;
      resetAntiCheatStates();
      generateQuizQuestions();
      setupAntiCheatListeners();
      renderQuiz();
    }

    // Handle answer selection
    function handleAnswerSelect(answerIndex) {
      state.selectedAnswer = answerIndex;
      renderQuiz();
    }

    // Handle next question
    function handleNextQuestion() {
      if (state.selectedAnswer === state.quizQuestions[state.currentQuestion]?.correct) {
        state.score++;
      }

      if (state.currentQuestion < state.quizQuestions.length - 1) {
        state.currentQuestion++;
        state.selectedAnswer = null;
      } else {
        state.showResult = true;
        saveQuizResults();
      }
      
      renderQuiz();
    }

    // Save quiz results to Supabase
    async function saveQuizResults() {
      if (!state.currentUser) return;
      
      try {
        // Get current stats
        const { data: currentStats } = await supabase
          .from('nutrition_stats')
          .select('*')
          .eq('user_id', state.currentUser.id)
          .single();
        
        // Calculate new values
        const correctAnswers = (currentStats?.correct_answers || 0) + state.score;
        const wrongAnswers = (currentStats?.wrong_answers || 0) + (state.quizQuestions.length - state.score);
        const totalAnswers = correctAnswers + wrongAnswers;
        const accuracy = Math.round((correctAnswers / totalAnswers) * 100);
        
        // Update or insert stats
        const { error } = await supabase
          .from('nutrition_stats')
          .upsert({
            user_id: state.currentUser.id,
            correct_answers: correctAnswers,
            wrong_answers: wrongAnswers,
            total_answers: totalAnswers,
            accuracy: accuracy,
            last_quiz_date: new Date().toISOString()
          });
        
        if (error) throw error;
        
        // Refresh top users
        await fetchTopUsers();
      } catch (error) {
        console.error('Error saving quiz results:', error);
      }
    }

    // Set up anti-cheat listeners
    function setupAntiCheatListeners() {
      if (!state.showQuiz) return;

      // Handle suspicious activity
      const handleSuspiciousActivity = () => {
        state.isScreenBlocked = true;
        state.suspiciousActivity++;
        renderQuiz();
        
        // Auto-unblock after 3 seconds as a warning
        setTimeout(() => {
          state.isScreenBlocked = false;
          renderQuiz();
        }, 3000);
      };

      // Disable right-click during quiz
      const handleContextMenu = (e) => {
        e.preventDefault();
        handleSuspiciousActivity();
        return false;
      };

      // Disable keyboard shortcuts
      const handleKeyDown = (e) => {
        // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, Print Screen, etc.
        if (
          e.keyCode === 123 || // F12
          (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
          (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
          (e.ctrlKey && e.keyCode === 83) || // Ctrl+S
          e.keyCode === 44 || // Print Screen
          (e.ctrlKey && e.keyCode === 80) || // Ctrl+P
          (e.altKey && e.keyCode === 115) || // Alt+F4
          (e.ctrlKey && e.keyCode === 82) // Ctrl+R
        ) {
          e.preventDefault();
          handleSuspiciousActivity();
          return false;
        }
      };

      // Detect tab switching/window focus changes
      const handleVisibilityChange = () => {
        if (document.hidden && state.showQuiz) {
          state.tabSwitchCount++;
          handleSuspiciousActivity();
          renderQuiz();
        }
      };

      const handleWindowFocus = () => {
        state.isWindowFocused = true;
        renderQuiz();
      };

      const handleWindowBlur = () => {
        if (state.showQuiz) {
          state.isWindowFocused = false;
          state.tabSwitchCount++;
          handleSuspiciousActivity();
          renderQuiz();
        }
      };

      // Check for mobile screenshot gestures (volume + power button)
      const handleTouchStart = (e) => {
        if (e.touches.length > 1) {
          handleSuspiciousActivity();
        }
      };

      // Dev tools detection
      const detectDevTools = () => {
        setInterval(() => {
          if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
            handleSuspiciousActivity();
          }
        }, 1000);
      };

      // Add event listeners
      document.addEventListener('contextmenu', handleContextMenu);
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('focus', handleWindowFocus);
      window.addEventListener('blur', handleWindowBlur);
      document.addEventListener('touchstart', handleTouchStart);
      
      // Start detections
      detectDevTools();
      state.quizStartTime = new Date().getTime();

      // Store listeners for cleanup
      state.antiCheatListeners = {
        handleContextMenu,
        handleKeyDown,
        handleVisibilityChange,
        handleWindowFocus,
        handleWindowBlur,
        handleTouchStart
      };
    }

    // Remove anti-cheat listeners
    function removeAntiCheatListeners() {
      if (!state.antiCheatListeners) return;
      
      const {
        handleContextMenu,
        handleKeyDown,
        handleVisibilityChange,
        handleWindowFocus,
        handleWindowBlur,
        handleTouchStart
      } = state.antiCheatListeners;

      document.removeEventListener('contextmenu', handleContextMenu);
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('focus', handleWindowFocus);
      window.removeEventListener('blur', handleWindowBlur);
      document.removeEventListener('touchstart', handleTouchStart);
    }

    // Render mindfulness leaderboard
    async function renderMindfulnessLeaderboard() {
      console.log('Rendering mindfulness leaderboard...');
      
      try {
        // Fetch mindfulness data from Supabase
        const { data: mindfulnessData, error } = await supabase
          .from('user_stats')
          .select(`
            breathing_level, 
            total_breathing_sessions, 
            meditation_minutes, 
            focus_sessions, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order('breathing_level', { ascending: false })
          .limit(10);
        
        let currentData = [];
        
        if (error) {
          console.log('Using test mindfulness data due to error:', error);
          // Create test leaderboard data
          currentData = Array.from({ length: 5 }, (_, i) => ({
            user_profiles: {
              username: `MindfulUser${i+1}`,
              avatar_url: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face'
            },
            breathing_level: 10 - i,
            total_breathing_sessions: 35 - (i * 5),
            meditation_minutes: 1000 - (i * 100),
            focus_sessions: 50 - (i * 5)
          }));
          
          // Add our top test user
          currentData.unshift({
            user_profiles: {
              username: state.testUsers[0].username,
              avatar_url: state.testUsers[0].avatar_url
            },
            breathing_level: state.testUsers[0].breathing_level,
            total_breathing_sessions: state.testUsers[0].total_breathing_sessions,
            meditation_minutes: state.testUsers[0].meditation_minutes,
            focus_sessions: state.testUsers[0].focus_sessions
          });
        } else {
          currentData = mindfulnessData || [];
        }
        
        const html = `
          <div class="space-y-6">
            <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
              <button
                onclick="state.activeMindfulnessTab = 'breathing'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'breathing' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="brain" class="w-4 h-4 inline mr-2"></i>
                Breathing Level
              </button>
              <button
                onclick="state.activeMindfulnessTab = 'meditation'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'meditation' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="moon" class="w-4 h-4 inline mr-2"></i>
                Meditation
              </button>
              <button
                onclick="state.activeMindfulnessTab = 'focus'; renderMindfulnessLeaderboard();"
                class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                  state.activeMindfulnessTab === 'focus' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="target" class="w-4 h-4 inline mr-2"></i>
                Focus Sessions
              </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200">
              <div class="p-6 border-b border-slate-200">
                <div class="flex items-center space-x-2">
                  <i data-lucide="brain" class="w-5 h-5"></i>
                  <h3 class="text-lg font-semibold text-slate-900">Top Mindfulness Practitioners</h3>
                </div>
              </div>
              
              <div class="p-6">
                <div class="space-y-4">
                  ${currentData.map((user, index) => `
                    <div key="${user.user_profiles?.username || 'anonymous'}" class="flex items-center justify-between p-4 rounded-lg border-2 ${getRankBg(index + 1)}">
                      <div class="flex items-center space-x-4">
                        ${getRankIcon(index + 1)}
                        <img 
                          src="${user.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face'}" 
                          alt="${user.user_profiles?.username || 'Anonymous'}"
                          class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm"
                        />
                        <div>
                          <h4 class="font-semibold text-slate-900">${user.user_profiles?.username || 'Anonymous User'}</h4>
                          <div class="flex items-center space-x-4 text-sm text-slate-600">
                            <span class="flex items-center">
                              <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                              ${user.total_breathing_sessions || 0} sessions
                            </span>
                            ${state.activeMindfulnessTab === 'meditation' ? `
                              <span class="flex items-center">
                                <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                                ${user.meditation_minutes || 0} mins
                              </span>
                            ` : ''}
                            ${state.activeMindfulnessTab === 'focus' ? `
                              <span class="flex items-center">
                                <i data-lucide="target" class="w-4 h-4 mr-1"></i>
                                ${user.focus_sessions || 0} sessions
                              </span>
                            ` : ''}
                          </div>
                        </div>
                      </div>
                      
                      <div class="text-right">
                        <div class="text-2xl font-bold text-slate-900">
                          ${state.activeMindfulnessTab === 'breathing' ? user.breathing_level || 1 :
                            state.activeMindfulnessTab === 'meditation' ? user.meditation_minutes || 0 :
                            user.focus_sessions || 0}
                        </div>
                        <div class="text-sm text-slate-500">
                          ${state.activeMindfulnessTab === 'breathing' ? 'Level' :
                            state.activeMindfulnessTab === 'meditation' ? 'Minutes' :
                            'Sessions'}
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;

        elements.mindfulnessLeaderboard.innerHTML = html;
        lucide.createIcons();
        console.log('Mindfulness leaderboard rendered successfully');
      } catch (error) {
        console.error('Error rendering mindfulness leaderboard:', error);
        elements.mindfulnessLeaderboard.innerHTML = `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
            <div class="text-slate-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">Error loading data</h3>
              <p class="text-sm">Please check your connection and try again.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Render nutrition leaderboard
    async function renderNutritionLeaderboard() {
      console.log('Rendering nutrition leaderboard...');
      
      try {
        // Fetch nutrition data from Supabase
        const { data: nutritionData, error } = await supabase
          .from('nutrition_stats')
          .select(`
            correct_answers, 
            wrong_answers, 
            total_answers, 
            accuracy, 
            user_id,
            user_profiles!inner(username, avatar_url)
          `)
          .order(state.activeNutritionTab === 'correct' ? 'correct_answers' : 
                state.activeNutritionTab === 'wrong' ? 'wrong_answers' : 'total_answers', 
                { ascending: false })
          .limit(10);
        
        let currentData = [];
        
        if (error) {
          console.log('Using test nutrition data due to error:', error);
          // Create test leaderboard data
          currentData = Array.from({ length: 5 }, (_, i) => ({
            user_profiles: {
              username: `NutritionUser${i+1}`,
              avatar_url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face'
            },
            correct_answers: 25 - (i * 3),
            wrong_answers: 5 + i,
            total_answers: 30 - (i * 2),
            accuracy: 80 - (i * 5)
          }));
          
          // Add our top test user
          currentData.unshift({
            user_profiles: {
              username: state.testUsers[1].username,
              avatar_url: state.testUsers[1].avatar_url
            },
            correct_answers: state.testUsers[1].correct_answers,
            wrong_answers: state.testUsers[1].wrong_answers,
            total_answers: state.testUsers[1].total_answers,
            accuracy: state.testUsers[1].accuracy
          });
        } else {
          currentData = nutritionData || [];
        }
        
        let title, icon, valueKey, valueLabel;
        
        switch(state.activeNutritionTab) {
          case 'correct':
            title = 'Most Correct Answers';
            icon = '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>';
            valueKey = 'correct_answers';
            valueLabel = 'correct';
            break;
          case 'wrong':
            title = 'Most Wrong Answers';
            icon = '<i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>';
            valueKey = 'wrong_answers';
            valueLabel = 'wrong';
            break;
          case 'total':
            title = 'Most Active Learners';
            icon = '<i data-lucide="users" class="w-5 h-5 text-blue-600"></i>';
            valueKey = 'total_answers';
            valueLabel = 'total';
            break;
        }

        const html = `
          <div class="space-y-6">
            <div class="flex space-x-1 bg-slate-100 p-1 rounded-lg">
              <button
                onclick="state.activeNutritionTab = 'correct'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'correct' 
                    ? 'bg-white text-green-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                Most Correct
              </button>
              <button
                onclick="state.activeNutritionTab = 'wrong'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'wrong' 
                    ? 'bg-white text-red-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="x-circle" class="w-4 h-4 inline mr-1"></i>
                Most Wrong
              </button>
              <button
                onclick="state.activeNutritionTab = 'total'; renderNutritionLeaderboard();"
                class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                  state.activeNutritionTab === 'total' 
                    ? 'bg-white text-blue-600 shadow-sm' 
                    : 'text-slate-600 hover:text-slate-900'
                }"
              >
                <i data-lucide="users" class="w-4 h-4 inline mr-1"></i>
                Most Active
              </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200">
              <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  ${icon}
                  <h3 class="text-lg font-semibold text-slate-900">${title}</h3>
                </div>
                <button
                  onclick="startQuiz()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2"
                >
                  <i data-lucide="play" class="w-4 h-4"></i>
                  <span>Take Quiz</span>
                </button>
              </div>
              
              <div class="p-6">
                <div class="space-y-4">
                  ${currentData.map((user, index) => `
                    <div key="${user.user_profiles?.username || 'anonymous'}" class="flex items-center justify-between p-4 rounded-lg border-2 ${getRankBg(index + 1)}">
                      <div class="flex items-center space-x-4">
                        ${getRankIcon(index + 1)}
                        <img 
                          src="${user.user_profiles?.avatar_url || 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=40&h=40&fit=crop&crop=face'}" 
                          alt="${user.user_profiles?.username || 'Anonymous'}"
                          class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm"
                        />
                        <div>
                          <h4 class="font-semibold text-slate-900">${user.user_profiles?.username || 'Anonymous User'}</h4>
                          <div class="flex items-center space-x-4 text-sm text-slate-600">
                            <span class="text-green-600">‚úì ${user.correct_answers || 0}</span>
                            <span class="text-red-600">‚úó ${user.wrong_answers || 0}</span>
                            <span class="text-blue-600">${user.accuracy || 0}% accuracy</span>
                          </div>
                        </div>
                      </div>
                      
                      <div class="text-right">
                        <div class="text-2xl font-bold text-slate-900">
                          ${user[valueKey] || 0}
                        </div>
                        <div class="text-sm text-slate-500">
                          ${valueLabel}
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;

        elements.nutritionLeaderboard.innerHTML = html;
        lucide.createIcons();
        console.log('Nutrition leaderboard rendered successfully');
      } catch (error) {
        console.error('Error rendering nutrition leaderboard:', error);
        elements.nutritionLeaderboard.innerHTML = `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
            <div class="text-slate-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">Error loading data</h3>
              <p class="text-sm">Please check your connection and try again.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Render quiz
    function renderQuiz() {
      if (!state.showQuiz) {
        // Remove any existing quiz modal
        const existingModal = document.getElementById('quizModal');
        if (existingModal) existingModal.remove();
        return;
      }

      if (state.isGeneratingQuiz) {
        const html = `
          <div id="quizModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
              <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold text-slate-900 mb-2">Generating Your Quiz</h3>
                <p class="text-slate-600">AI is creating personalized questions for your grade level...</p>
              </div>
            </div>
          </div>
        `;
        
        // Remove any existing quiz modal
        const existingModal = document.getElementById('quizModal');
        if (existingModal) existingModal.remove();
        
        // Insert new modal
        document.body.insertAdjacentHTML('beforeend', html);
        return;
      }

      // Anti-cheat screen blocker
      if (state.isScreenBlocked) {
        const html = `
          <div id="quizModal" class="fixed inset-0 bg-black flex items-center justify-center z-50">
            <div class="text-center text-white p-8">
              <div class="text-6xl mb-4">‚ö†Ô∏è</div>
              <h2 class="text-3xl font-bold mb-4">SUSPICIOUS ACTIVITY DETECTED</h2>
              <p class="text-xl mb-2">Screen capture or unauthorized access attempt detected!</p>
              <p class="text-lg opacity-80">Quiz will resume automatically...</p>
              <div class="mt-6">
                <div class="text-red-400 text-sm">
                  ‚Ä¢ Tab switches: ${state.tabSwitchCount}<br>
                  ‚Ä¢ Suspicious actions: ${state.suspiciousActivity}
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove any existing quiz modal
        const existingModal = document.getElementById('quizModal');
        if (existingModal) existingModal.remove();
        
        // Insert new modal
        document.body.insertAdjacentHTML('beforeend', html);
        return;
      }

      if (state.showResult) {
        // Calculate quiz integrity score
        const totalTime = state.quizStartTime ? (new Date().getTime() - state.quizStartTime) / 1000 : 0;
        const avgTimePerQuestion = totalTime / state.quizQuestions.length;
        const integrityScore = Math.max(0, 100 - (state.suspiciousActivity * 10) - (state.tabSwitchCount * 15));
        const isValidScore = integrityScore >= 50 && avgTimePerQuestion >= 10;
        
        const html = `
          <div id="quizModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
              <div class="text-center">
                <i data-lucide="star" class="w-16 h-16 text-yellow-500 mx-auto mb-4"></i>
                <h3 class="text-2xl font-bold text-slate-900 mb-2">Quiz Complete!</h3>
                <div class="text-4xl font-bold text-blue-600 mb-2">${state.score}/${state.quizQuestions.length}</div>
                <p class="text-slate-600 mb-4">
                  You got ${state.score} out of ${state.quizQuestions.length} questions correct!
                </p>
                
                <div class="p-4 rounded-lg mb-4 ${isValidScore ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                  <div class="flex items-center justify-center space-x-2 mb-2">
                    <div class="w-3 h-3 rounded-full ${isValidScore ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="font-semibold ${isValidScore ? 'text-green-700' : 'text-red-700'}">
                      Integrity Score: ${integrityScore}%
                    </span>
                  </div>
                  <div class="text-sm text-slate-600">
                    <div>Time: ${Math.round(totalTime)}s (${Math.round(avgTimePerQuestion)}s/question)</div>
                    <div>Tab switches: ${state.tabSwitchCount}</div>
                    <div>Suspicious actions: ${state.suspiciousActivity}</div>
                  </div>
                  ${!isValidScore ? `
                    <div class="text-red-600 text-sm mt-2 font-medium">
                      ‚ö†Ô∏è Score not eligible for leaderboard due to low integrity
                    </div>
                  ` : ''}
                </div>
                
                <div class="flex space-x-3">
                  <button
                    onclick="startQuiz()"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                  >
                    Try Again
                  </button>
                  <button
                    onclick="resetQuiz()"
                    class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 px-4 rounded-lg font-medium transition-colors"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove any existing quiz modal
        const existingModal = document.getElementById('quizModal');
        if (existingModal) existingModal.remove();
        
        // Insert new modal
        document.body.insertAdjacentHTML('beforeend', html);
        lucide.createIcons();
        return;
      }

      if (!state.quizQuestions.length) return;

      const question = state.quizQuestions[state.currentQuestion];

      const html = `
        <div id="quizModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div 
            class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto select-none"
            style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;"
            ondragstart="event.preventDefault()"
          >
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-6">
              <div class="flex items-center justify-between text-sm">
                <div class="flex items-center space-x-2">
                  <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                  <span class="text-red-700 font-medium">Anti-Cheat Active</span>
                </div>
                <div class="text-red-600">
                  Focus: ${state.isWindowFocused ? '‚úì' : '‚úó'} | Switches: ${state.tabSwitchCount}
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center space-x-2">
                <i data-lucide="brain" class="w-6 h-6 text-blue-600"></i>
                <span class="font-semibold text-slate-900">Nutrition Quiz</span>
              </div>
              <div class="flex items-center space-x-4">
                <span class="text-sm text-slate-600">
                  ${state.currentQuestion + 1} of ${state.quizQuestions.length}
                </span>
                <button
                  onclick="resetQuiz()"
                  class="text-slate-400 hover:text-slate-600"
                >
                  ‚úï
                </button>
              </div>
            </div>

            <div class="mb-8">
              <div class="w-full bg-slate-200 rounded-full h-2 mb-6">
                <div 
                  class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                  style="width: ${((state.currentQuestion + 1) / state.quizQuestions.length) * 100}%"
                ></div>
              </div>

              <h3 class="text-xl font-semibold text-slate-900 mb-6">
                ${question.question}
              </h3>

              <div class="space-y-3">
                ${question.options.map((option, index) => `
                  <button
                    key="${index}"
                    onclick="handleAnswerSelect(${index})"
                    class="w-full p-4 text-left rounded-lg border-2 transition-colors ${
                      state.selectedAnswer === index
                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                        : 'border-slate-200 hover:border-slate-300 text-slate-700'
                    }"
                    style="user-select: none; -webkit-user-select: none;"
                  >
                    <div class="flex items-center space-x-3">
                      <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                        state.selectedAnswer === index
                          ? 'border-blue-500 bg-blue-500 text-white'
                          : 'border-slate-300'
                      }">
                        ${state.selectedAnswer === index ? '‚úì' : ''}
                      </div>
                      <span>${option}</span>
                    </div>
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="flex justify-between">
              <button
                onclick="resetQuiz()"
                class="px-6 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors"
              >
                Cancel
              </button>
              <button
                onclick="handleNextQuestion()"
                ${state.selectedAnswer === null ? 'disabled' : ''}
                class="px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2 ${
                  state.selectedAnswer !== null
                    ? 'bg-blue-600 hover:bg-blue-700 text-white'
                    : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                }"
              >
                <span>${state.currentQuestion === state.quizQuestions.length - 1 ? 'Finish' : 'Next'}</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remove any existing quiz modal
      const existingModal = document.getElementById('quizModal');
      if (existingModal) existingModal.remove();
      
      // Insert new modal
      document.body.insertAdjacentHTML('beforeend', html);
      lucide.createIcons();
    }

    // Reset quiz
    function resetQuiz() {
      state.showQuiz = false;
      state.currentQuestion = 0;
      state.selectedAnswer = null;
      state.showResult = false;
      state.score = 0;
      state.quizQuestions = [];
      resetAntiCheatStates();
      removeAntiCheatListeners();
      renderQuiz();
    }

    // Initialize the app
    init();

    // Make functions available globally
    window.startQuiz = startQuiz;
    window.handleAnswerSelect = handleAnswerSelect;
    window.handleNextQuestion = handleNextQuestion;
    window.resetQuiz = resetQuiz;
    window.state = state;
  </script>
</body>
</html>
