<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAD - Mindfulness</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            min-height: 100vh;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 80px;
            font-weight: bold;
            color: #dc2626;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .loading-motto {
            color: white;
            font-size: 18px;
            text-align: center;
            opacity: 0.9;
            animation: fadeInUp 1s ease-out 0.5s both;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 0.9;
                transform: translateY(0);
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #dc2626;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .nav-buttons button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            margin-left: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-buttons button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-content {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            padding: 40px 20px;
        }

        .main-content.visible {
            opacity: 1;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .welcome-section {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .welcome-title {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 18px;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #8b5cf6;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }

        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
        }

        .activity-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }

        .activity-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .activity-description {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .activity-button {
            width: 100%;
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .activity-button:hover {
            background: #7c3aed;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .breathing-exercise {
            text-align: center;
            padding: 20px;
        }

        .breathing-circle {
            width: 200px;
            height: 200px;
            border: 4px solid #8b5cf6;
            border-radius: 50%;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #8b5cf6;
            transition: all 0.3s ease;
        }

        .breathing-circle.inhale {
            transform: scale(1.3);
            background: rgba(139, 92, 246, 0.1);
        }

        .breathing-circle.exhale {
            transform: scale(0.8);
            background: rgba(139, 92, 246, 0.05);
        }

        .breathing-controls {
            margin-top: 30px;
        }

        .breathing-controls button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .breathing-controls button:hover {
            background: #7c3aed;
        }

        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9fafb;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #8b5cf6;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.ai {
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #8b5cf6;
        }

        .chat-send {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .meditation-list, .book-list, .sound-grid, .color-noise-grid {
            display: grid;
            gap: 15px;
        }

        .meditation-item, .book-item, .sound-item, .color-noise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }

        .meditation-item:hover, .book-item:hover, .sound-item:hover, .color-noise-item:hover {
            background: #f3f4f6;
        }

        .meditation-info, .book-info, .sound-info, .color-noise-info {
            flex: 1;
        }

        .meditation-info h4, .book-info h4, .sound-info h4, .color-noise-info h4 {
            color: #1f2937;
            margin-bottom: 5px;
        }

        .meditation-info p, .book-info p, .sound-info p, .color-noise-info p {
            color: #6b7280;
            font-size: 14px;
        }

        .meditation-play, .book-play, .sound-play, .color-noise-play {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .sound-icon, .color-noise-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .color-noise-button {
            width: 100%;
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .color-noise-button:hover {
            background: #4f46e5;
        }

        .custom-breathing-form {
            margin-top: 20px;
        }

        .custom-breathing-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #1f2937;
        }

        .custom-breathing-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
        }

        .custom-breathing-form button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
        }

        .xp-progress {
            width: 100%;
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .xp-progress-bar {
            height: 100%;
            background-color: #8b5cf6;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .timer-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #1f2937;
        }

        .finger-press-container {
            margin: 20px 0;
            text-align: center;
        }

        .finger-press-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #8b5cf6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }

        .finger-press-btn:active {
            transform: scale(0.95);
            background: #7c3aed;
        }

        .press-instruction {
            margin-top: 10px;
            color: #6b7280;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .activities-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .breathing-circle {
                width: 150px;
                height: 150px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">LEAD</div>
        <div class="loading-motto">Learn. Empower. Achieve. Dream.</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="logo">LEAD - Mindfulness</div>
        <div class="nav-buttons">
            <button onclick="goHome()">Home</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="dashboard">
            <div class="welcome-section">
                <h1 class="welcome-title">Mindfulness Center</h1>
                <p class="welcome-subtitle">Find peace, build resilience, track your journey</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="breathingLevel">1</div>
                    <div class="stat-label">Breathing Level</div>
                    <div class="xp-progress">
                        <div class="xp-progress-bar" id="xpProgressBar"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMinutes">0</div>
                    <div class="stat-label">Minutes Practiced</div>
                </div>
            </div>

            <!-- Activities Grid -->
            <div class="activities-grid">
                <div class="activity-card" onclick="openTherapyChat()">
                    <div class="activity-icon">üó£Ô∏è</div>
                    <div class="activity-title">AI Therapy Assistant</div>
                    <div class="activity-description">
                        Talk about your feelings and problems with our compassionate AI therapist, available 24/7.
                    </div>
                    <button class="activity-button">Talk Therapy</button>
                </div>

                <div class="activity-card" onclick="openBreathingExercise()">
                    <div class="activity-icon">ü´Å</div>
                    <div class="activity-title">Breathing Exercises</div>
                    <div class="activity-description">
                        Practice different breathing techniques to reduce stress and increase focus.
                    </div>
                    <button class="activity-button">Start Breathing</button>
                </div>

                <div class="activity-card" onclick="openBookMeditation()">
                    <div class="activity-icon">üìö</div>
                    <div class="activity-title">Book Meditation</div>
                    <div class="activity-description">
                        Learn while you relax - listen to transformative books in 15-min daily sessions.
                    </div>
                    <button class="activity-button">Browse Books</button>
                </div>

                <div class="activity-card" onclick="openFocusMode()">
                    <div class="activity-icon">üéØ</div>
                    <div class="activity-title">Focus Mode</div>
                    <div class="activity-description">
                        Ambient sounds to boost concentration - rain, ocean, fireplace and color noises.
                    </div>
                    <button class="activity-button">Start Focusing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Therapy Chat Modal -->
    <div id="therapyChatModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('therapyChatModal')">&times;</span>
            <h2>AI Therapy Assistant</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">I'm here to listen and support you. Feel free to share what's on your mind.</p>
            
            <div class="chat-container" id="therapyChatContainer">
                <div class="chat-message ai">
                    <p>Hello! I'm your AI therapy assistant. I'm here to provide a safe space for you to talk about your feelings, thoughts, and any challenges you're facing. What would you like to discuss today?</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="therapyChatInput" placeholder="Type your message here..." onkeypress="handleTherapyChatKeyPress(event)">
                <button class="chat-send" onclick="sendTherapyMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Breathing Exercise Modal -->
    <div id="breathingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('breathingModal')">&times;</span>
            <div class="breathing-exercise">
                <h2>Breathing Exercise</h2>
                <p id="breathingInstruction">Choose an exercise to begin</p>
                
                <div class="finger-press-container" id="fingerPressContainer" style="display: none;">
                    <div class="finger-press-btn" id="fingerPressBtn" 
                         ontouchstart="startFingerPress()" 
                         onmousedown="startFingerPress()"
                         ontouchend="stopFingerPress()"
                         onmouseup="stopFingerPress()">
                        Hold
                    </div>
                    <p class="press-instruction">Keep your finger pressed to continue</p>
                </div>
                
                <div class="breathing-circle" id="breathingCircle">
                    <span id="breathingText">Ready</span>
                </div>
                
                <div class="breathing-controls">
                    <button onclick="prepareBreathingExercise('box')">Box Breathing (4-4-4-4)</button>
                    <button onclick="prepareBreathingExercise('deep')">Deep Breathing (4-6)</button>
                    <button onclick="prepareBreathingExercise('calm')">Calming Breath (4-7-8)</button>
                    <button onclick="openCustomBreathing()" id="customBreathingBtn">Custom Breathing</button>
                    <button onclick="stopBreathingExercise()" id="stopBreathingBtn" style="display: none; background: #dc2626;">Stop</button>
                </div>
                
                <div style="margin-top: 20px;">
                    <p>Duration: <span id="breathingDuration">00:00</span></p>
                    <p>XP Earned: <span id="breathingXp">0</span></p>
                    <p>Next Level: <span id="nextLevelXp">100</span> XP</p>
                    <div class="xp-progress">
                        <div class="xp-progress-bar" id="breathingXpProgress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Breathing Modal -->
    <div id="customBreathingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('customBreathingModal')">&times;</span>
            <div class="breathing-exercise">
                <h2>Custom Breathing Exercise</h2>
                <p id="customBreathingInstruction">Create your own breathing pattern</p>
                
                <div class="custom-breathing-form">
                    <label for="inhaleDuration">Inhale Duration (seconds):</label>
                    <input type="number" id="inhaleDuration" min="2" max="20" value="4">
                    
                    <label for="holdDuration">Hold Duration (seconds):</label>
                    <input type="number" id="holdDuration" min="0" max="20" value="4">
                    
                    <label for="exhaleDuration">Exhale Duration (seconds):</label>
                    <input type="number" id="exhaleDuration" min="2" max="20" value="6">
                    
                    <button onclick="startCustomBreathing()">Start Custom Breathing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Meditation Modal -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bookModal')">&times;</span>
            <h2>Book Meditation</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">Listen to these transformative books in 15-minute daily sessions.</p>
            
            <div class="book-list">
                <div class="book-item" onclick="playBook('Atomic Habits', 'James Clear', 'Tiny changes, remarkable results. Learn how to build good habits and break bad ones.', 18000, 'https://youtu.be/3LIWqYdBW5w')">
                    <div class="book-info">
                        <h4>Atomic Habits</h4>
                        <p>James Clear ‚Ä¢ 5 hours ‚Ä¢ Tiny changes, remarkable results</p>
                    </div>
                    <button class="book-play">Play</button>
                </div>
                
                <div class="book-item" onclick="playBook('The 48 Laws of Power', 'Robert Greene', 'Learn the principles of power that have shaped history and can help you navigate complex social situations.', 36000, 'https://youtu.be/_pd6H5ogkug')">
                    <div class="book-info">
                        <h4>The 48 Laws of Power</h4>
                        <p>Robert Greene ‚Ä¢ 10 hours ‚Ä¢ Master the principles of power</p>
                    </div>
                    <button class="book-play">Play</button>
                </div>
                
                <div class="book-item" onclick="playBook('The 5 Love Languages', 'Gary Chapman', 'Discover how to express love in ways that will be meaningful to your partner and strengthen your relationship.', 14400, 'https://youtu.be/M0YiJ-t8EJk')">
                    <div class="book-info">
                        <h4>The 5 Love Languages</h4>
                        <p>Gary Chapman ‚Ä¢ 4 hours ‚Ä¢ Strengthen your relationships</p>
                    </div>
                    <button class="book-play">Play</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Focus Mode Modal -->
    <div id="focusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('focusModal')">&times;</span>
            <h2>Focus Mode</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">Select a sound to help you concentrate or relax.</p>
            
            <div class="sound-grid">
                <div class="sound-item" onclick="playFocusSound('Ocean Waves with Piano', 3600, 'https://youtu.be/kmhKuif1JCI', 'Gentle waves with calming piano melodies')">
                    <div class="sound-icon">üåä</div>
                    <div class="sound-info">
                        <h4>Ocean Waves with Piano</h4>
                        <p>Gentle waves with calming piano melodies (1 hour)</p>
                    </div>
                    <button class="sound-play">Play</button>
                </div>
                
                <div class="sound-item" onclick="playFocusSound('Rain & Fireplace', 10800, 'https://youtu.be/3sL0omwElxw', 'Cozy combination of rain and crackling fire')">
                    <div class="sound-icon">üåßÔ∏èüî•</div>
                    <div class="sound-info">
                        <h4>Rain & Fireplace</h4>
                        <p>Cozy combination of rain and crackling fire (3 hours)</p>
                    </div>
                    <button class="sound-play">Play</button>
                </div>
                
                <div class="sound-item" onclick="playFocusSound('Just Rain', 36000, 'https://youtu.be/zbmP1JP9DNc', 'Pure rain sounds for deep focus')">
                    <div class="sound-icon">üåßÔ∏è</div>
                    <div class="sound-info">
                        <h4>Just Rain</h4>
                        <p>Pure rain sounds for deep focus (10 hours)</p>
                    </div>
                    <button class="sound-play">Play</button>
                </div>
            </div>
            
            <button class="color-noise-button" onclick="openColorNoises()">Explore Color Noises</button>
        </div>
    </div>

    <!-- Color Noises Modal -->
    <div id="colorNoiseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('colorNoiseModal')">&times;</span>
            <h2>Color Noises</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">Different noise colors have different effects on focus and relaxation.</p>
            
            <div class="color-noise-grid">
                <div class="color-noise-item" onclick="playColorNoise('White Noise', 'Equal energy across all frequencies - good for masking distractions', 'https://youtu.be/nMfPqeZjc2c')">
                    <div class="color-noise-icon">‚ö™</div>
                    <div class="color-noise-info">
                        <h4>White Noise</h4>
                        <p>Equal energy across all frequencies - good for masking distractions</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Pink Noise', 'More power in lower frequencies - natural and calming', 'https://youtu.be/HIkAOMw_sjw')">
                    <div class="color-noise-icon">üå∏</div>
                    <div class="color-noise-info">
                        <h4>Pink Noise</h4>
                        <p>More power in lower frequencies - natural and calming</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Brown Noise', 'Strong low frequencies - deep and grounding', 'https://youtu.be/snlA7rFR0iQ')">
                    <div class="color-noise-icon">üü§</div>
                    <div class="color-noise-info">
                        <h4>Brown Noise</h4>
                        <p>Strong low frequencies - deep and grounding</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Blue Noise', 'Emphasizes higher frequencies - sharp and intense', 'https://youtu.be/A7LjWtnw8d8')">
                    <div class="color-noise-icon">üîµ</div>
                    <div class="color-noise-info">
                        <h4>Blue Noise</h4>
                        <p>Emphasizes higher frequencies - sharp and intense</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Violet Noise', 'Very high-frequency only - technical use', 'https://youtu.be/tbV22kjkL10')">
                    <div class="color-noise-icon">üü£</div>
                    <div class="color-noise-info">
                        <h4>Violet Noise</h4>
                        <p>Very high-frequency only - technical use</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Gray Noise', 'Perceptually balanced to human hearing', 'https://youtu.be/I83F4sdpZnM')">
                    <div class="color-noise-icon">‚ö´</div>
                    <div class="color-noise-info">
                        <h4>Gray Noise</h4>
                        <p>Perceptually balanced to human hearing</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Green Noise', 'Mid-to-low frequencies - peaceful and natural', 'https://youtu.be/LKOkPHSlBc4')">
                    <div class="color-noise-icon">üåø</div>
                    <div class="color-noise-info">
                        <h4>Green Noise</h4>
                        <p>Mid-to-low frequencies - peaceful and natural</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="stopPlayer()">&times;</span>
            <h2 id="playerTitle">Now Playing</h2>
            <p id="playerDescription" style="color: #6b7280; margin-bottom: 20px;"></p>
            
            <div class="timer-display" id="playerTimer">00:00</div>
            
            <div id="youtubePlayer" style="width: 100%; height: 0; padding-bottom: 56.25%; position: relative;">
                <iframe id="youtubeIframe" width="100%" height="100%" style="position: absolute; top: 0; left: 0;" 
                    frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen></iframe>
            </div>
            
            <div style="margin-top: 20px;">
                <p>Session Progress: <span id="sessionProgress">0</span> minutes</p>
                <p>XP Earned: <span id="playerXp">0</span></p>
                <div class="xp-progress">
                    <div class="xp-progress-bar" id="playerXpProgress"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://fhthwxgkxuontprzclhb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZodGh3eGdreHVvbnRwcnpjbGhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDczNDgsImV4cCI6MjA2OTYyMzM0OH0.9mEHL1jpYXkMeWg0UNKK5LYPosj0eou4k-mw3eof-ZU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            db: {
                schema: 'public'
            },
            auth: {
                persistSession: true,
                autoRefreshToken: true
            }
        });
        
        // OpenRouter configuration
        const OPENROUTER_API_KEY = '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';
        
        let currentUser = null;
        let currentUserStats = null;
        let breathingTimer = null;
        let breathingStartTime = null;
        let breathingDurationInterval = null;
        let currentXp = 0;
        let nextLevelXp = 100;
        let playerInterval = null;
        let playerStartTime = null;
        let playerElapsedTime = 0;
        let currentSessionType = null;
        let currentSessionName = null;
        let currentSessionUrl = null;
        let fingerPressInterval = null;
        let fingerPressActive = false;
        let currentExerciseType = null;

        // Check authentication and load user data
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = user;
                await loadUserStats();
            } catch (error) {
                console.error('Authentication error:', error);
                window.location.href = 'index.html';
            }
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                const { data: stats, error } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();
                
                if (error) throw error;
                
                if (!stats) {
                    // Initialize stats if they don't exist
                    const { data: newStats, error: initError } = await supabase
                        .from('user_stats')
                        .insert({
                            user_id: currentUser.id,
                            breathing_level: 1,
                            breathing_xp: 0,
                            total_breathing_sessions: 0,
                            total_meditation_sessions: 0,
                            total_book_sessions: 0,
                            total_focus_sessions: 0,
                            total_minutes: 0,
                            last_session_date: null
                        })
                        .select()
                        .single();
                    
                    if (initError) throw initError;
                    currentUserStats = newStats;
                    return updateUIWithStats(newStats);
                }
                
                currentUserStats = stats;
                updateUIWithStats(stats);
                
                // Calculate total minutes from all sessions
                await calculateTotalMinutes();
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        async function calculateTotalMinutes() {
            try {
                const { data: breathingSessions } = await supabase
                    .from('breathing_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const { data: meditationSessions } = await supabase
                    .from('meditation_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const { data: bookSessions } = await supabase
                    .from('book_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const { data: focusSessions } = await supabase
                    .from('focus_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const totalMinutes = Math.floor(
                    ((breathingSessions || []).reduce((sum, session) => sum + session.duration, 0) +
                    (meditationSessions || []).reduce((sum, session) => sum + session.duration, 0) +
                    (bookSessions || []).reduce((sum, session) => sum + session.duration, 0) +
                    (focusSessions || []).reduce((sum, session) => sum + session.duration, 0)) / 60
                );
                
                document.getElementById('totalMinutes').textContent = totalMinutes;
            } catch (error) {
                console.error('Error calculating total minutes:', error);
            }
        }

        function updateUIWithStats(stats) {
            document.getElementById('breathingLevel').textContent = stats.breathing_level || 1;
            document.getElementById('totalSessions').textContent = 
                (stats.total_breathing_sessions || 0) + 
                (stats.total_meditation_sessions || 0) + 
                (stats.total_book_sessions || 0) + 
                (stats.total_focus_sessions || 0);
            
            currentXp = stats.breathing_xp || 0;
            nextLevelXp = 100 * (stats.breathing_level || 1);
            updateXpProgress(currentXp, nextLevelXp);
            
            // Show/hide custom breathing button based on level
            const customBtn = document.getElementById('customBreathingBtn');
            if (stats.breathing_level >= 2) {
                customBtn.style.display = 'inline-block';
            } else {
                customBtn.style.display = 'none';
            }
        }

        function updateXpProgress(current, needed) {
            const percentage = Math.min(100, (current / needed) * 100);
            document.getElementById('xpProgressBar').style.width = `${percentage}%`;
            document.getElementById('breathingXpProgress').style.width = `${percentage}%`;
            document.getElementById('playerXpProgress').style.width = `${percentage}%`;
            document.getElementById('breathingXp').textContent = current;
            document.getElementById('playerXp').textContent = current;
            document.getElementById('nextLevelXp').textContent = needed;
        }

        // Show loading screen and then main content
        function showContent() {
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('visible');
            }, 2000);
        }

        // Navigation functions
        function goHome() {
            window.location.href = 'menu.html';
        }

        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                window.location.href = 'index.html';
            }
        }

        // Modal functions
        function openTherapyChat() {
            document.getElementById('therapyChatModal').style.display = 'block';
        }

        function openBreathingExercise() {
            document.getElementById('breathingModal').style.display = 'block';
        }

        function openCustomBreathing() {
            if (currentUserStats.breathing_level < 2) {
                alert("Custom breathing exercises unlock at Level 2!");
                return;
            }
            document.getElementById('customBreathingModal').style.display = 'block';
        }

        function openBookMeditation() {
            document.getElementById('bookModal').style.display = 'block';
        }

        function openFocusMode() {
            document.getElementById('focusModal').style.display = 'block';
        }

        function openColorNoises() {
            document.getElementById('colorNoiseModal').style.display = 'block';
            document.getElementById('focusModal').style.display = 'none';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'breathingModal') {
                stopBreathingExercise();
            }
        }

        // Therapy Chat Functions
        async function sendTherapyMessage() {
            const input = document.getElementById('therapyChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatContainer = document.getElementById('therapyChatContainer');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = `<p>${message}</p>`;
            chatContainer.appendChild(userMessage);
            
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'HTTP-Referer': 'https://project-l-e-a-d-academy.github.io',
                        'X-Title': 'LEAD Wellness App',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat-v3-0324:free',
                        messages: [{
                            role: 'system',
                            content: 'You are a compassionate AI therapy assistant for teenagers. Provide supportive, empathetic responses. Focus on active listening, validation, and gentle guidance. Keep responses conversational and age-appropriate. If someone expresses serious mental health concerns, gently suggest they talk to a trusted adult or professional.'
                        }, {
                            role: 'user',
                            content: message
                        }],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                // Add AI response
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = `<p>${data.choices[0].message.content}</p>`;
                chatContainer.appendChild(aiMessage);
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Save chat session
                await saveTherapyChat(message, data.choices[0].message.content);
            } catch (error) {
                console.error('Error sending therapy message:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message ai';
                errorMessage.innerHTML = `<p>I'm having connection issues. Please try again later.</p>`;
                chatContainer.appendChild(errorMessage);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function saveTherapyChat(userMessage, aiResponse) {
            try {
                // Check if there's an existing active chat session
                const { data: existingChat, error: fetchError } = await supabase
                    .from('therapy_chats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                let chatId = null;
                let messages = [];
                
                if (!fetchError && existingChat.length > 0) {
                    // Continue existing chat
                    chatId = existingChat[0].id;
                    messages = existingChat[0].messages;
                }
                
                // Add new messages
                messages.push({
                    role: 'user',
                    content: userMessage,
                    timestamp: new Date().toISOString()
                }, {
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toISOString()
                });
                
                // Generate a session name from user's first message
                let sessionName = 'Therapy Session';
                if (messages.length === 2) { // Only for first message
                    sessionName = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
                }
                
                // Upsert chat session
                const { error } = await supabase
                    .from('therapy_chats')
                    .upsert({
                        id: chatId,
                        user_id: currentUser.id,
                        session_name: sessionName,
                        messages: messages,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
            } catch (error) {
                console.error('Error saving therapy chat:', error);
            }
        }

        function handleTherapyChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendTherapyMessage();
            }
        }

        // Breathing Exercise Functions
        function prepareBreathingExercise(type) {
            currentExerciseType = type;
            document.getElementById('fingerPressContainer').style.display = 'block';
            document.getElementById('breathingInstruction').textContent = 'Press and hold the button to begin';
        }

        function startFingerPress() {
            fingerPressActive = true;
            fingerPressInterval = setInterval(() => {
                // Check if still pressing every second
                if (!fingerPressActive) {
                    clearInterval(fingerPressInterval);
                    document.getElementById('breathingInstruction').textContent = 'Press and hold the button to continue';
                }
            }, 1000);
            
            // Start exercise after 3 seconds of continuous press
            setTimeout(() => {
                if (fingerPressActive) {
                    document.getElementById('fingerPressContainer').style.display = 'none';
                    startBreathingExercise(currentExerciseType);
                }
            }, 3000);
        }

        function stopFingerPress() {
            fingerPressActive = false;
            if (fingerPressInterval) {
                clearInterval(fingerPressInterval);
            }
        }

        function startBreathingExercise(type) {
            const circle = document.getElementById('breathingCircle');
            const text = document.getElementById('breathingText');
            const instruction = document.getElementById('breathingInstruction');
            const stopBtn = document.getElementById('stopBreathingBtn');
            
            stopBtn.style.display = 'inline-block';
            breathingStartTime = Date.now();
            
            // Start duration counter
            breathingDurationInterval = setInterval(updateBreathingDuration, 1000);
            
            let cycles = {
                box: { inhale: 4, hold1: 4, exhale: 4, hold2: 4 },
                deep: { inhale: 4, hold1: 0, exhale: 6, hold2: 0 },
                calm: { inhale: 4, hold1: 7, exhale: 8, hold2: 0 }
            };
            
            let cycle = cycles[type];
            let phase = 0; // 0: inhale, 1: hold1, 2: exhale, 3: hold2
            let count = 0;
            
            const phases = ['inhale', 'hold1', 'exhale', 'hold2'];
            const phaseTexts = ['Inhale', 'Hold', 'Exhale', 'Hold'];
            const phaseDurations = [cycle.inhale, cycle.hold1, cycle.exhale, cycle.hold2];
            
            instruction.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Breathing - Follow the circle`;
            
            function breathingCycle() {
                if (!breathingTimer) return;
                
                const currentPhase = phases[phase];
                const duration = phaseDurations[phase];
                
                if (duration === 0) {
                    phase = (phase + 1) % 4;
                    return breathingCycle();
                }
                
                text.textContent = `${phaseTexts[phase]} ${duration - count}`;
                
                if (currentPhase === 'inhale') {
                    circle.className = 'breathing-circle inhale';
                } else if (currentPhase === 'exhale') {
                    circle.className = 'breathing-circle exhale';
                } else {
                    circle.className = 'breathing-circle';
                }
                
                count++;
                
                if (count > duration) {
                    count = 0;
                    phase = (phase + 1) % 4;
                }
            }
            
            breathingTimer = setInterval(breathingCycle, 1000);
            breathingCycle();
        }

        function startCustomBreathing() {
            const inhale = parseInt(document.getElementById('inhaleDuration').value) || 4;
            const hold = parseInt(document.getElementById('holdDuration').value) || 0;
            const exhale = parseInt(document.getElementById('exhaleDuration').value) || 6;
            
            const circle = document.getElementById('breathingCircle');
            const text = document.getElementById('breathingText');
            const instruction = document.getElementById('breathingInstruction');
            const stopBtn = document.getElementById('stopBreathingBtn');
            
            closeModal('customBreathingModal');
            
            stopBtn.style.display = 'inline-block';
            breathingStartTime = Date.now();
            
            // Start duration counter
            breathingDurationInterval = setInterval(updateBreathingDuration, 1000);
            
            let cycle = { inhale: inhale, hold1: hold, exhale: exhale, hold2: 0 };
            let phase = 0; // 0: inhale, 1: hold1, 2: exhale, 3: hold2
            let count = 0;
            
            const phases = ['inhale', 'hold1', 'exhale', 'hold2'];
            const phaseTexts = ['Inhale', 'Hold', 'Exhale', 'Hold'];
            const phaseDurations = [cycle.inhale, cycle.hold1, cycle.exhale, cycle.hold2];
            
            instruction.textContent = `Custom Breathing (${inhale}-${hold}-${exhale}) - Follow the circle`;
            
            function breathingCycle() {
                if (!breathingTimer) return;
                
                const currentPhase = phases[phase];
                const duration = phaseDurations[phase];
                
                if (duration === 0) {
                    phase = (phase + 1) % 4;
                    return breathingCycle();
                }
                
                text.textContent = `${phaseTexts[phase]} ${duration - count}`;
                
                if (currentPhase === 'inhale') {
                    circle.className = 'breathing-circle inhale';
                } else if (currentPhase === 'exhale') {
                    circle.className = 'breathing-circle exhale';
                } else {
                    circle.className = 'breathing-circle';
                }
                
                count++;
                
                if (count > duration) {
                    count = 0;
                    phase = (phase + 1) % 4;
                }
            }
            
            breathingTimer = setInterval(breathingCycle, 1000);
            breathingCycle();
        }

        function stopBreathingExercise() {
            if (breathingTimer) {
                clearInterval(breathingTimer);
                breathingTimer = null;
            }
            
            if (breathingDurationInterval) {
                clearInterval(breathingDurationInterval);
                breathingDurationInterval = null;
            }
            
            const circle = document.getElementById('breathingCircle');
            const text = document.getElementById('breathingText');
            const instruction = document.getElementById('breathingInstruction');
            const stopBtn = document.getElementById('stopBreathingBtn');
            
            circle.className = 'breathing-circle';
            text.textContent = 'Session Complete';
            instruction.textContent = 'Great job! Choose another exercise or close to continue.';
            stopBtn.style.display = 'none';
            
            // Save session if it lasted more than 7 minutes (420 seconds)
            if (breathingStartTime && Date.now() - breathingStartTime > 420000) {
                saveBreathingSession();
            }
            
            document.getElementById('breathingDuration').textContent = '00:00';
            document.getElementById('breathingXp').textContent = '0';
        }

        function updateBreathingDuration() {
            if (breathingStartTime) {
                const elapsed = Math.floor((Date.now() - breathingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('breathingDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update XP display (10 XP per minute)
                const xp = minutes * 10;
                document.getElementById('breathingXp').textContent = xp;
                updateXpProgress(currentXp + xp, nextLevelXp);
            }
        }

        async function saveBreathingSession() {
            if (!breathingStartTime) return;
            
            const duration = Math.floor((Date.now() - breathingStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const { data: currentStats } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                    
                // Calculate experience points (10 XP per minute)
                const xpEarned = minutes * 10;
                const currentLevel = currentStats?.breathing_level || 1;
                const currentXp = currentStats?.breathing_xp || 0;
                const totalXp = currentXp + xpEarned;
                const xpNeeded = 100 * currentLevel;
                const levelsGained = Math.floor(totalXp / xpNeeded);
                const newLevel = currentLevel + levelsGained;
                const remainingXp = totalXp % xpNeeded;
                
                // Only show level up modal for levels 5, 10, 15, etc.
                const shouldShowLevelUp = levelsGained > 0 && newLevel % 5 === 0;
                
                // Save breathing session
                const { error: sessionError } = await supabase
                    .from('breathing_sessions')
                    .insert({
                        user_id: user.id,
                        session_type: 'breathing',
                        duration: duration,
                        level: newLevel,
                        xp_earned: xpEarned,
                        custom_pattern: document.getElementById('customBreathingBtn').style.display === 'inline-block'
                    });
                    
                if (sessionError) throw sessionError;
                
                // Update user stats
                const { error: statsError } = await supabase
                    .from('user_stats')
                    .upsert({
                        user_id: user.id,
                        total_breathing_sessions: (currentStats?.total_breathing_sessions || 0) + 1,
                        breathing_level: newLevel,
                        breathing_xp: remainingXp,
                        last_session_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    
                if (statsError) throw statsError;
                
                // Show level up message if applicable
                if (levelsGained > 0) {
                    const circle = document.getElementById('breathingCircle');
                    const text = document.getElementById('breathingText');
                    circle.className = 'breathing-circle inhale';
                    text.textContent = `Level ${newLevel}!`;
                    
                    if (shouldShowLevelUp) {
                        closeModal('breathingModal');
                        alert(`Congratulations! You've reached Level ${newLevel}!`);
                    }
                    
                    setTimeout(() => {
                        circle.className = 'breathing-circle';
                        text.textContent = 'Session Complete';
                    }, 3000);
                }
                
                await loadUserStats();
            } catch (error) {
                console.error('Error saving breathing session:', error);
            }
        }

        // Book Meditation Functions
        function playBook(title, author, description, duration, url) {
            currentSessionType = 'book';
            currentSessionName = title;
            currentSessionUrl = url;
            
            document.getElementById('playerTitle').textContent = title;
            document.getElementById('playerDescription').textContent = `${author} ‚Ä¢ ${description}`;
            document.getElementById('playerModal').style.display = 'block';
            document.getElementById('bookModal').style.display = 'none';
            
            // Load YouTube video
            const videoId = extractVideoId(url);
            document.getElementById('youtubeIframe').src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
            
            // Start timer
            startPlayerTimer();
        }

        // Focus Mode Functions
        function playFocusSound(name, duration, url, description) {
            currentSessionType = 'focus';
            currentSessionName = name;
            currentSessionUrl = url;
            
            document.getElementById('playerTitle').textContent = name;
            document.getElementById('playerDescription').textContent = description;
            document.getElementById('playerModal').style.display = 'block';
            document.getElementById('focusModal').style.display = 'none';
            document.getElementById('colorNoiseModal').style.display = 'none';
            
            // Load YouTube video
            const videoId = extractVideoId(url);
            document.getElementById('youtubeIframe').src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
            
            // Start timer
            startPlayerTimer();
        }

        function playColorNoise(name, description, url) {
            currentSessionType = 'focus';
            currentSessionName = name;
            currentSessionUrl = url;
            
            document.getElementById('playerTitle').textContent = name;
            document.getElementById('playerDescription').textContent = description;
            document.getElementById('playerModal').style.display = 'block';
            document.getElementById('colorNoiseModal').style.display = 'none';
            
            // Load YouTube video
            const videoId = extractVideoId(url);
            document.getElementById('youtubeIframe').src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
            
            // Start timer
            startPlayerTimer();
        }

        function extractVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function startPlayerTimer() {
            playerStartTime = Date.now();
            playerElapsedTime = 0;
            document.getElementById('playerTimer').textContent = '00:00';
            document.getElementById('sessionProgress').textContent = '0';
            
            if (playerInterval) {
                clearInterval(playerInterval);
            }
            
            playerInterval = setInterval(updatePlayerTimer, 1000);
        }

        function updatePlayerTimer() {
            playerElapsedTime = Math.floor((Date.now() - playerStartTime) / 1000);
            const minutes = Math.floor(playerElapsedTime / 60);
            const seconds = playerElapsedTime % 60;
            
            document.getElementById('playerTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update session progress (counts every full minute)
            document.getElementById('sessionProgress').textContent = minutes;
            
            // For books, save progress every 15 minutes
            if (currentSessionType === 'book' && minutes > 0 && minutes % 15 === 0) {
                savePlayerSession();
            }
            
            // For focus sounds, save progress every 15 minutes
            if (currentSessionType === 'focus' && minutes > 0 && minutes % 15 === 0) {
                savePlayerSession();
            }
        }

        async function savePlayerSession() {
            if (!playerStartTime) return;
            
            const duration = playerElapsedTime;
            const minutes = Math.floor(duration / 60);
            
            try {
                // First verify the user exists
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                // Get current stats
                const { data: currentStats } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                let sessionTable, sessionData, statsUpdate;
                const xpEarned = minutes * 5; // 5 XP per minute for these activities
                
                if (currentSessionType === 'book') {
                    sessionTable = 'book_sessions';
                    sessionData = {
                        user_id: user.id,
                        book_title: currentSessionName,
                        duration: duration,
                        progress: minutes,
                        completed: minutes >= 15 // Mark as completed if at least 15 minutes
                    };
                    
                    statsUpdate = {
                        total_book_sessions: (currentStats?.total_book_sessions || 0) + 1,
                        last_session_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                } else if (currentSessionType === 'focus') {
                    sessionTable = 'focus_sessions';
                    sessionData = {
                        user_id: user.id,
                        sound_type: currentSessionName,
                        duration: duration,
                        completed: minutes >= 15 // Mark as completed if at least 15 minutes
                    };
                    
                    statsUpdate = {
                        total_focus_sessions: (currentStats?.total_focus_sessions || 0) + 1,
                        last_session_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                }
                
                // Save session
                const { error: sessionError } = await supabase
                    .from(sessionTable)
                    .insert(sessionData);
                    
                if (sessionError) throw sessionError;
                
                // Update user stats
                const { error: statsError } = await supabase
                    .from('user_stats')
                    .upsert(statsUpdate);
                    
                if (statsError) throw statsError;
                
                await loadUserStats();
            } catch (error) {
                console.error('Error saving player session:', error);
            }
        }

        function stopPlayer() {
            if (playerInterval) {
                clearInterval(playerInterval);
                playerInterval = null;
            }
            
            // Save session if it lasted more than 15 minutes
            if (playerStartTime && playerElapsedTime >= 900) {
                savePlayerSession();
            }
            
            // Stop YouTube video
            document.getElementById('youtubeIframe').src = '';
            document.getElementById('playerModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (modal.id === 'breathingModal') {
                        stopBreathingExercise();
                    }
                    if (modal.id === 'playerModal') {
                        stopPlayer();
                    }
                }
            }
        }

        // Initialize page
        window.addEventListener('load', async () => {
            await checkAuth();
            showContent();
        });
    </script>
</body>
</html>
