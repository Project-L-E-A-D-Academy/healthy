<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LEAD - Mindfulness</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #741576;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25' viewBox='0 0 800 400'%3E%3Cdefs%3E%3CradialGradient id='a' cx='396' cy='281' r='514' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23D18'/%3E%3Cstop offset='1' stop-color='%23741576'/%3E%3C/radialGradient%3E%3ClinearGradient id='b' gradientUnits='userSpaceOnUse' x1='400' y1='148' x2='400' y2='333'%3E%3Cstop offset='0' stop-color='%23FA3' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%23FA3' stop-opacity='0.5'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23a)' width='800' height='400'/%3E%3Cg fill-opacity='0.4'%3E%3Ccircle fill='url(%23b)' cx='267.5' cy='61' r='300'/%3E%3Ccircle fill='url(%23b)' cx='532.5' cy='61' r='300'/%3E%3Ccircle fill='url(%23b)' cx='400' cy='30' r='300'/%3E%3C/g%3E%3C/svg%3E");
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            overflow-x: hidden;
            animation: bgZoom 30s infinite alternate ease-in-out;
        }

        @keyframes bgZoom {
            0% { background-size: 100% auto; }
            100% { background-size: 110% auto; }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.8s ease-out;
            backdrop-filter: blur(5px);
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 5rem;
            font-weight: bold;
            color: #dc2626;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1);
            animation: pulse 2s ease-in-out infinite;
            margin-bottom: 1.5rem;
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loading-motto {
            color: white;
            font-size: 1.2rem;
            text-align: center;
            opacity: 0.9;
            animation: fadeInUp 1s ease-out 0.5s both;
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.5px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(220, 38, 38, 0.2);
            border-radius: 50%;
            border-top-color: #dc2626;
            margin-top: 2rem;
            animation: spin 1s linear infinite;
        }

        .loading-dots {
            display: flex;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #8b5cf6;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 0.9;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Main Content */
        .main-content {
            opacity: 0;
            transition: opacity 0.8s ease-in;
        }

        .main-content.visible {
            opacity: 1;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #1f2937;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 0 0 20px 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc2626;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .welcome-section {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            padding: 1rem;
        }

        .welcome-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-family: 'Playfair Display', serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .welcome-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #8b5cf6;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .xp-progress {
            width: 100%;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .xp-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
        }

        .activity-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
        }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            animation: rainbow 8s linear infinite;
            background-size: 400% 400%;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .activity-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            transition: transform 0.3s ease;
        }

        .activity-card:hover .activity-icon {
            transform: scale(1.1);
        }

        .mindfulness-icon {
            color: #8b5cf6;
        }

        .nutrition-icon {
            color: #10b981;
        }

        .activity-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.8rem;
            font-family: 'Playfair Display', serif;
        }

        .activity-description {
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .activity-button {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 0.8rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .activity-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
            text-align: center;
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            text-align: center;
        }

        .modal-features {
            list-style: none;
            text-align: left;
            margin: 1.5rem 0;
        }

        .modal-features li {
            padding: 0.5rem 0;
            color: #4b5563;
            position: relative;
            padding-left: 1.5rem;
            font-size: 0.9rem;
        }

        .modal-features li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .modal-button {
            display: block;
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            text-align: center;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Breathing Exercise Styles */
        .breathing-exercise {
            text-align: center;
            padding: 1rem;
        }

        .breathing-circle {
            width: 200px;
            height: 200px;
            border: 4px solid #8b5cf6;
            border-radius: 50%;
            margin: 1.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #8b5cf6;
            transition: all 0.3s ease;
        }

        .breathing-circle.inhale {
            transform: scale(1.3);
            background: rgba(139, 92, 246, 0.1);
        }

        .breathing-circle.exhale {
            transform: scale(0.8);
            background: rgba(139, 92, 246, 0.05);
        }

        .breathing-controls {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .breathing-controls button {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 0.8rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .breathing-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .breathing-controls button.stop {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .finger-press-container {
            margin: 1rem 0;
            text-align: center;
        }

        .finger-press-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .finger-press-btn:active {
            transform: scale(0.95);
        }

        .press-instruction {
            margin-top: 0.5rem;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
            color: #1f2937;
        }

        /* Chat Styles */
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.8rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9fafb;
        }

        .chat-message {
            margin-bottom: 0.8rem;
            padding: 0.8rem;
            border-radius: 0.8rem;
            max-width: 80%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.user {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.ai {
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            margin-right: auto;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 2rem;
            font-size: 0.9rem;
            outline: none;
        }

        .chat-input:focus {
            border-color: #8b5cf6;
        }

        .chat-send {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.2rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chat-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* List Styles */
        .meditation-list, .book-list, .sound-grid, .color-noise-grid {
            display: grid;
            gap: 0.8rem;
        }

        .meditation-item, .book-item, .sound-item, .color-noise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: #f9fafb;
            border-radius: 0.8rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
        }

        .meditation-item:hover, .book-item:hover, .sound-item:hover, .color-noise-item:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .meditation-info, .book-info, .sound-info, .color-noise-info {
            flex: 1;
        }

        .meditation-info h4, .book-info h4, .sound-info h4, .color-noise-info h4 {
            color: #1f2937;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .meditation-info p, .book-info p, .sound-info p, .color-noise-info p {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .meditation-play, .book-play, .sound-play, .color-noise-play {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .meditation-play:hover, .book-play:hover, .sound-play:hover, .color-noise-play:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .sound-icon, .color-noise-icon {
            font-size: 1.5rem;
            margin-right: 0.8rem;
        }

        .color-noise-button {
            width: 100%;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 0.8rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-noise-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Custom Breathing Form */
        .custom-breathing-form {
            margin-top: 1rem;
        }

        .custom-breathing-form label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .custom-breathing-form input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .custom-breathing-form button {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 0.5rem;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .custom-breathing-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Player Modal */
        #youtubePlayer {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            position: relative;
            margin: 1rem 0;
            border-radius: 0.8rem;
            overflow: hidden;
        }

        #youtubeIframe {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            border: none;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 0.8rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .logo {
                font-size: 1.3rem;
                margin-bottom: 0.3rem;
            }
            
            .nav-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.7rem;
            }
            
            .welcome-title {
                font-size: 1.5rem;
            }
            
            .welcome-subtitle {
                font-size: 0.9rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .activities-grid {
                grid-template-columns: 1fr;
            }
            
            .activity-card {
                padding: 1.2rem;
            }
            
            .activity-icon {
                font-size: 2.5rem;
            }
            
            .activity-title {
                font-size: 1.2rem;
            }
            
            .activity-description {
                font-size: 0.85rem;
            }
            
            .breathing-circle {
                width: 150px;
                height: 150px;
                font-size: 1rem;
            }
            
            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }
            
            .modal-title {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .loading-logo {
                font-size: 3.5rem;
            }
            
            .loading-motto {
                font-size: 1rem;
            }
            
            .header {
                padding: 0.6rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .nav-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.65rem;
            }
            
            .welcome-title {
                font-size: 1.3rem;
            }
            
            .welcome-subtitle {
                font-size: 0.8rem;
            }
            
            .stat-card {
                padding: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.7rem;
            }
            
            .activity-card {
                padding: 1rem;
            }
            
            .activity-icon {
                font-size: 2rem;
            }
            
            .activity-title {
                font-size: 1.1rem;
            }
            
            .activity-description {
                font-size: 0.8rem;
            }
            
            .breathing-circle {
                width: 120px;
                height: 120px;
                font-size: 0.9rem;
            }
            
            .modal-content {
                padding: 1.2rem;
            }
            
            .modal-title {
                font-size: 1.1rem;
            }
            
            .modal-features li {
                font-size: 0.8rem;
            }
            
            .chat-message {
                font-size: 0.8rem;
                padding: 0.6rem;
            }
            
            .chat-input {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            .chat-send {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">LEAD</div>
        <div class="loading-motto">Learn. Empower. Achieve. Dream.</div>
        <div class="loading-spinner"></div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="logo">LEAD - Mindfulness</div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="goHome()">
                <i data-lucide="home"></i> Home
            </button>
            <button class="nav-btn" onclick="logout()">
                <i data-lucide="log-out"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="dashboard">
            <div class="welcome-section">
                <h1 class="welcome-title">Mindfulness Center</h1>
                <p class="welcome-subtitle">Find peace, build resilience, track your journey</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="breathingLevel">1</div>
                    <div class="stat-label">Breathing Level</div>
                    <div class="xp-progress">
                        <div class="xp-progress-bar" id="xpProgressBar"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalMinutes">0</div>
                    <div class="stat-label">Minutes Practiced</div>
                </div>
            </div>

            <!-- Activities Grid -->
            <div class="activities-grid">
                <div class="activity-card" id="therapyCard">
                    <div class="activity-icon mindfulness-icon">üó£Ô∏è</div>
                    <div class="activity-title">AI Therapy Assistant</div>
                    <div class="activity-description">
                        Talk about your feelings and problems with our compassionate AI therapist, available 24/7.
                    </div>
                    <button class="activity-button">Talk Therapy</button>
                </div>

                <div class="activity-card" id="breathingCard">
                    <div class="activity-icon mindfulness-icon">ü´Å</div>
                    <div class="activity-title">Breathing Exercises</div>
                    <div class="activity-description">
                        Practice different breathing techniques to reduce stress and increase focus.
                    </div>
                    <button class="activity-button">Start Breathing</button>
                </div>

                <div class="activity-card" id="bookCard">
                    <div class="activity-icon mindfulness-icon">üìö</div>
                    <div class="activity-title">Book Meditation</div>
                    <div class="activity-description">
                        Learn while you relax - listen to transformative books in 15-min daily sessions.
                    </div>
                    <button class="activity-button">Browse Books</button>
                </div>

                <div class="activity-card" id="focusCard">
                    <div class="activity-icon mindfulness-icon">üéØ</div>
                    <div class="activity-title">Focus Mode</div>
                    <div class="activity-description">
                        Ambient sounds to boost concentration - rain, ocean, fireplace and color noises.
                    </div>
                    <button class="activity-button">Start Focusing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Therapy Chat Modal -->
    <div class="modal-overlay" id="therapyChatModal">
        <div class="modal-content">
            <button class="modal-close" id="therapyModalClose">&times;</button>
            <div class="modal-icon mindfulness-icon">üó£Ô∏è</div>
            <div class="modal-title">AI Therapy Assistant</div>
            <p style="color: #6b7280; margin-bottom: 1rem; text-align: center;">I'm here to listen and support you. Feel free to share what's on your mind.</p>
            
            <div class="chat-container" id="therapyChatContainer">
                <div class="chat-message ai">
                    <p>Hello! I'm your AI therapy assistant. I'm here to provide a safe space for you to talk about your feelings, thoughts, and any challenges you're facing. What would you like to discuss today?</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="therapyChatInput" placeholder="Type your message here..." onkeypress="handleTherapyChatKeyPress(event)">
                <button class="chat-send" onclick="sendTherapyMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Breathing Exercise Modal -->
    <div class="modal-overlay" id="breathingModal">
        <div class="modal-content">
            <button class="modal-close" id="breathingModalClose">&times;</button>
            <div class="modal-icon mindfulness-icon">ü´Å</div>
            <div class="modal-title">Breathing Exercises</div>
            
            <div class="breathing-exercise">
                <p id="breathingInstruction" style="color: #6b7280; text-align: center;">Choose an exercise to begin</p>
                
                <div class="finger-press-container" id="fingerPressContainer" style="display: none;">
                    <div class="finger-press-btn" id="fingerPressBtn" 
                         ontouchstart="startFingerPress()" 
                         onmousedown="startFingerPress()"
                         ontouchend="stopFingerPress()"
                         onmouseup="stopFingerPress()">
                        Hold
                    </div>
                    <p class="press-instruction">Keep your finger pressed to continue</p>
                </div>
                
                <div class="breathing-circle" id="breathingCircle">
                    <span id="breathingText">Ready</span>
                </div>
                
                <div class="breathing-controls">
                    <button onclick="prepareBreathingExercise('box')">Box Breathing (4-4-4-4)</button>
                    <button onclick="prepareBreathingExercise('deep')">Deep Breathing (4-6)</button>
                    <button onclick="prepareBreathingExercise('calm')">Calming Breath (4-7-8)</button>
                    <button onclick="openCustomBreathing()" id="customBreathingBtn">Custom Breathing</button>
                    <button onclick="stopBreathingExercise()" id="stopBreathingBtn" style="display: none;" class="stop">Stop</button>
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <p>Duration: <span id="breathingDuration">00:00</span></p>
                    <p>XP Earned: <span id="breathingXp">0</span></p>
                    <p>Next Level: <span id="nextLevelXp">100</span> XP</p>
                    <div class="xp-progress">
                        <div class="xp-progress-bar" id="breathingXpProgress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Breathing Modal -->
    <div class="modal-overlay" id="customBreathingModal">
        <div class="modal-content">
            <button class="modal-close" id="customBreathingModalClose">&times;</button>
            <div class="modal-icon mindfulness-icon">ü´Å</div>
            <div class="modal-title">Custom Breathing</div>
            <p id="customBreathingInstruction" style="color: #6b7280; text-align: center;">Create your own breathing pattern</p>
            
            <div class="custom-breathing-form">
                <label for="inhaleDuration">Inhale Duration (seconds):</label>
                <input type="number" id="inhaleDuration" min="2" max="20" value="4">
                
                <label for="holdDuration">Hold Duration (seconds):</label>
                <input type="number" id="holdDuration" min="0" max="20" value="4">
                
                <label for="exhaleDuration">Exhale Duration (seconds):</label>
                <input type="number" id="exhaleDuration" min="2" max="20" value="6">
                
                <button onclick="startCustomBreathing()">Start Custom Breathing</button>
            </div>
        </div>
    </div>

    <!-- Book Meditation Modal -->
    <div class="modal-overlay" id="bookModal">
        <div class="modal-content">
            <button class="modal-close" id="bookModalClose">&times;</button>
            <div class="modal-icon mindfulness-icon">üìö</div>
            <div class="modal-title">Book Meditation</div>
            <p style="color: #6b7280; margin-bottom: 1rem; text-align: center;">Listen to these transformative books in 15-minute daily sessions.</p>
            
            <div class="book-list">
                <div class="book-item" onclick="playBook('Atomic Habits', 'James Clear', 'Tiny changes, remarkable results. Learn how to build good habits and break bad ones.', 18000, 'https://youtu.be/3LIWqYdBW5w')">
                    <div class="book-info">
                        <h4>Atomic Habits</h4>
                        <p>James Clear ‚Ä¢ 5 hours ‚Ä¢ Tiny changes, remarkable results</p>
                    </div>
                    <button class="book-play">Play</button>
                </div>
                
                <div class="book-item" onclick="playBook('The 48 Laws of Power', 'Robert Greene', 'Learn the principles of power that have shaped history and can help you navigate complex social situations.', 36000, 'https://youtu.be/_pd6H5ogkug')">
                    <div class="book-info">
                        <h4>The 48 Laws of Power</h4>
                        <p>Robert Greene ‚Ä¢ 10 hours ‚Ä¢ Master the principles of power</p>
                    </div>
                    <button class="book-play">Play</button>
                </div>
                
                <div class="book-item" onclick="playBook('The 5 Love Languages', 'Gary Chapman', 'Discover how to express love in ways that will be meaningful to your partner and strengthen your relationship.', 14400, 'https://youtu.be/M0YiJ-t8EJk')">
                    <div class="book-info">
                        <h4>The 5 Love Languages</h4>
                        <p>Gary Chapman ‚Ä¢ 4 hours ‚Ä¢ Strengthen your relationships</p>
                    </div>
                    <button class="book-play">Play</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Focus Mode Modal -->
    <div class="modal-overlay" id="focusModal">
        <div class="modal-content">
            <button class="modal-close" id="focusModalClose">&times;</button>
            <div class="modal-icon mindfulness-icon">üéØ</div>
            <div class="modal-title">Focus Mode</div>
            <p style="color: #6b7280; margin-bottom: 1rem; text-align: center;">Select a sound to help you concentrate or relax.</p>
            
            <div class="sound-grid">
                <div class="sound-item" onclick="playFocusSound('Ocean Waves with Piano', 3600, 'https://youtu.be/kmhKuif1JCI', 'Gentle waves with calming piano melodies')">
                    <div class="sound-icon">üåä</div>
                    <div class="sound-info">
                        <h4>Ocean Waves with Piano</h4>
                        <p>Gentle waves with calming piano melodies (1 hour)</p>
                    </div>
                    <button class="sound-play">Play</button>
                </div>
                
                <div class="sound-item" onclick="playFocusSound('Rain & Fireplace', 10800, 'https://youtu.be/3sL0omwElxw', 'Cozy combination of rain and crackling fire')">
                    <div class="sound-icon">üåßÔ∏èüî•</div>
                    <div class="sound-info">
                        <h4>Rain & Fireplace</h4>
                        <p>Cozy combination of rain and crackling fire (3 hours)</p>
                    </div>
                    <button class="sound-play">Play</button>
                </div>
                
                <div class="sound-item" onclick="playFocusSound('Just Rain', 36000, 'https://youtu.be/zbmP1JP9DNc', 'Pure rain sounds for deep focus')">
                    <div class="sound-icon">üåßÔ∏è</div>
                    <div class="sound-info">
                        <h4>Just Rain</h4>
                        <p>Pure rain sounds for deep focus (10 hours)</p>
                    </div>
                    <button class="sound-play">Play</button>
                </div>
            </div>
            
            <button class="color-noise-button" onclick="openColorNoises()">Explore Color Noises</button>
        </div>
    </div>

    <!-- Color Noises Modal -->
    <div class="modal-overlay" id="colorNoiseModal">
        <div class="modal-content">
            <button class="modal-close" id="colorNoiseModalClose">&times;</button>
            <div class="modal-icon mindfulness-icon">üåà</div>
            <div class="modal-title">Color Noises</div>
            <p style="color: #6b7280; margin-bottom: 1rem; text-align: center;">Different noise colors have different effects on focus and relaxation.</p>
            
            <div class="color-noise-grid">
                <div class="color-noise-item" onclick="playColorNoise('White Noise', 'Equal energy across all frequencies - good for masking distractions', 'https://youtu.be/nMfPqeZjc2c')">
                    <div class="color-noise-icon">‚ö™</div>
                    <div class="color-noise-info">
                        <h4>White Noise</h4>
                        <p>Equal energy across all frequencies - good for masking distractions</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Pink Noise', 'More power in lower frequencies - natural and calming', 'https://youtu.be/HIkAOMw_sjw')">
                    <div class="color-noise-icon">üå∏</div>
                    <div class="color-noise-info">
                        <h4>Pink Noise</h4>
                        <p>More power in lower frequencies - natural and calming</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Brown Noise', 'Strong low frequencies - deep and grounding', 'https://youtu.be/snlA7rFR0iQ')">
                    <div class="color-noise-icon">üü§</div>
                    <div class="color-noise-info">
                        <h4>Brown Noise</h4>
                        <p>Strong low frequencies - deep and grounding</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Blue Noise', 'Emphasizes higher frequencies - sharp and intense', 'https://youtu.be/A7LjWtnw8d8')">
                    <div class="color-noise-icon">üîµ</div>
                    <div class="color-noise-info">
                        <h4>Blue Noise</h4>
                        <p>Emphasizes higher frequencies - sharp and intense</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Violet Noise', 'Very high-frequency only - technical use', 'https://youtu.be/tbV22kjkL10')">
                    <div class="color-noise-icon">üü£</div>
                    <div class="color-noise-info">
                        <h4>Violet Noise</h4>
                        <p>Very high-frequency only - technical use</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Gray Noise', 'Perceptually balanced to human hearing', 'https://youtu.be/I83F4sdpZnM')">
                    <div class="color-noise-icon">‚ö´</div>
                    <div class="color-noise-info">
                        <h4>Gray Noise</h4>
                        <p>Perceptually balanced to human hearing</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
                
                <div class="color-noise-item" onclick="playColorNoise('Green Noise', 'Mid-to-low frequencies - peaceful and natural', 'https://youtu.be/LKOkPHSlBc4')">
                    <div class="color-noise-icon">üåø</div>
                    <div class="color-noise-info">
                        <h4>Green Noise</h4>
                        <p>Mid-to-low frequencies - peaceful and natural</p>
                    </div>
                    <button class="color-noise-play">Play</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Modal -->
    <div class="modal-overlay" id="playerModal">
        <div class="modal-content">
            <button class="modal-close" id="playerModalClose">&times;</button>
            <h2 id="playerTitle">Now Playing</h2>
            <p id="playerDescription" style="color: #6b7280; margin-bottom: 1rem; text-align: center;"></p>
            
            <div class="timer-display" id="playerTimer">00:00</div>
            
            <div id="youtubePlayer">
                <iframe id="youtubeIframe" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            
            <div style="margin-top: 1rem; text-align: center;">
                <p>Session Progress: <span id="sessionProgress">0</span> minutes</p>
                <p>XP Earned: <span id="playerXp">0</span></p>
                <div class="xp-progress">
                    <div class="xp-progress-bar" id="playerXpProgress"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://fhthwxgkxuontprzclhb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZodGh3eGdreHVvbnRwcnpjbGhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDczNDgsImV4cCI6MjA2OTYyMzM0OH0.9mEHL1jpYXkMeWg0UNKK5LYPosj0eou4k-mw3eof-ZU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            db: {
                schema: 'public'
            },
            auth: {
                persistSession: true,
                autoRefreshToken: true
            }
        });
        
        // OpenRouter configuration
        const OPENROUTER_API_KEY = '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';
        
        let currentUser = null;
        let currentUserStats = null;
        let breathingTimer = null;
        let breathingStartTime = null;
        let breathingDurationInterval = null;
        let currentXp = 0;
        let nextLevelXp = 100;
        let playerInterval = null;
        let playerStartTime = null;
        let playerElapsedTime = 0;
        let currentSessionType = null;
        let currentSessionName = null;
        let currentSessionUrl = null;
        let fingerPressInterval = null;
        let fingerPressActive = false;
        let currentExerciseType = null;

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            mainContent: document.getElementById('mainContent'),
            therapyCard: document.getElementById('therapyCard'),
            breathingCard: document.getElementById('breathingCard'),
            bookCard: document.getElementById('bookCard'),
            focusCard: document.getElementById('focusCard'),
            therapyChatModal: document.getElementById('therapyChatModal'),
            breathingModal: document.getElementById('breathingModal'),
            customBreathingModal: document.getElementById('customBreathingModal'),
            bookModal: document.getElementById('bookModal'),
            focusModal: document.getElementById('focusModal'),
            colorNoiseModal: document.getElementById('colorNoiseModal'),
            playerModal: document.getElementById('playerModal'),
            therapyModalClose: document.getElementById('therapyModalClose'),
            breathingModalClose: document.getElementById('breathingModalClose'),
            customBreathingModalClose: document.getElementById('customBreathingModalClose'),
            bookModalClose: document.getElementById('bookModalClose'),
            focusModalClose: document.getElementById('focusModalClose'),
            colorNoiseModalClose: document.getElementById('colorNoiseModalClose'),
            playerModalClose: document.getElementById('playerModalClose'),
            therapyChatContainer: document.getElementById('therapyChatContainer'),
            therapyChatInput: document.getElementById('therapyChatInput'),
            breathingCircle: document.getElementById('breathingCircle'),
            breathingText: document.getElementById('breathingText'),
            breathingInstruction: document.getElementById('breathingInstruction'),
            breathingDuration: document.getElementById('breathingDuration'),
            breathingXp: document.getElementById('breathingXp'),
            nextLevelXp: document.getElementById('nextLevelXp'),
            breathingXpProgress: document.getElementById('breathingXpProgress'),
            stopBreathingBtn: document.getElementById('stopBreathingBtn'),
            fingerPressContainer: document.getElementById('fingerPressContainer'),
            fingerPressBtn: document.getElementById('fingerPressBtn'),
            inhaleDuration: document.getElementById('inhaleDuration'),
            holdDuration: document.getElementById('holdDuration'),
            exhaleDuration: document.getElementById('exhaleDuration'),
            playerTitle: document.getElementById('playerTitle'),
            playerDescription: document.getElementById('playerDescription'),
            playerTimer: document.getElementById('playerTimer'),
            sessionProgress: document.getElementById('sessionProgress'),
            playerXp: document.getElementById('playerXp'),
            playerXpProgress: document.getElementById('playerXpProgress'),
            youtubeIframe: document.getElementById('youtubeIframe'),
            breathingLevel: document.getElementById('breathingLevel'),
            totalSessions: document.getElementById('totalSessions'),
            totalMinutes: document.getElementById('totalMinutes'),
            xpProgressBar: document.getElementById('xpProgressBar'),
            customBreathingBtn: document.getElementById('customBreathingBtn')
        };

        // Check authentication and load user data
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = user;
                await loadUserStats();
            } catch (error) {
                console.error('Authentication error:', error);
                window.location.href = 'index.html';
            }
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                const { data: stats, error } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();
                
                if (error) throw error;
                
                if (!stats) {
                    // Initialize stats if they don't exist
                    const { data: newStats, error: initError } = await supabase
                        .from('user_stats')
                        .insert({
                            user_id: currentUser.id,
                            breathing_level: 1,
                            breathing_xp: 0,
                            total_breathing_sessions: 0,
                            total_meditation_sessions: 0,
                            total_book_sessions: 0,
                            total_focus_sessions: 0,
                            total_minutes: 0,
                            last_session_date: null
                        })
                        .select()
                        .single();
                    
                    if (initError) throw initError;
                    currentUserStats = newStats;
                    return updateUIWithStats(newStats);
                }
                
                currentUserStats = stats;
                updateUIWithStats(stats);
                
                // Calculate total minutes from all sessions
                await calculateTotalMinutes();
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        async function calculateTotalMinutes() {
            try {
                const { data: breathingSessions } = await supabase
                    .from('breathing_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const { data: meditationSessions } = await supabase
                    .from('meditation_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const { data: bookSessions } = await supabase
                    .from('book_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const { data: focusSessions } = await supabase
                    .from('focus_sessions')
                    .select('duration')
                    .eq('user_id', currentUser.id);
                
                const totalMinutes = Math.floor(
                    ((breathingSessions || []).reduce((sum, session) => sum + session.duration, 0) +
                    (meditationSessions || []).reduce((sum, session) => sum + session.duration, 0) +
                    (bookSessions || []).reduce((sum, session) => sum + session.duration, 0) +
                    (focusSessions || []).reduce((sum, session) => sum + session.duration, 0)) / 60
                );
                
                elements.totalMinutes.textContent = totalMinutes;
            } catch (error) {
                console.error('Error calculating total minutes:', error);
            }
        }

        function updateUIWithStats(stats) {
            elements.breathingLevel.textContent = stats.breathing_level || 1;
            elements.totalSessions.textContent = 
                (stats.total_breathing_sessions || 0) + 
                (stats.total_meditation_sessions || 0) + 
                (stats.total_book_sessions || 0) + 
                (stats.total_focus_sessions || 0);
            
            currentXp = stats.breathing_xp || 0;
            nextLevelXp = 100 * (stats.breathing_level || 1);
            updateXpProgress(currentXp, nextLevelXp);
            
            // Show/hide custom breathing button based on level
            if (stats.breathing_level >= 2) {
                elements.customBreathingBtn.style.display = 'inline-block';
            } else {
                elements.customBreathingBtn.style.display = 'none';
            }
        }

        function updateXpProgress(current, needed) {
            const percentage = Math.min(100, (current / needed) * 100);
            elements.xpProgressBar.style.width = `${percentage}%`;
            elements.breathingXpProgress.style.width = `${percentage}%`;
            elements.playerXpProgress.style.width = `${percentage}%`;
            elements.breathingXp.textContent = current;
            elements.playerXp.textContent = current;
            elements.nextLevelXp.textContent = needed;
        }

        // Show loading screen and then main content
        function showContent() {
            setTimeout(() => {
                elements.loadingScreen.classList.add('hidden');
                elements.mainContent.classList.add('visible');
                lucide.createIcons();
            }, 2000);
        }

        // Toggle modal
        function toggleModal(modal, show) {
            if (show) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Card clicks
            elements.therapyCard.addEventListener('click', () => toggleModal(elements.therapyChatModal, true));
            elements.breathingCard.addEventListener('click', () => toggleModal(elements.breathingModal, true));
            elements.bookCard.addEventListener('click', () => toggleModal(elements.bookModal, true));
            elements.focusCard.addEventListener('click', () => toggleModal(elements.focusModal, true));
            
            // Modal close buttons
            elements.therapyModalClose.addEventListener('click', () => toggleModal(elements.therapyChatModal, false));
            elements.breathingModalClose.addEventListener('click', () => {
                toggleModal(elements.breathingModal, false);
                stopBreathingExercise();
            });
            elements.customBreathingModalClose.addEventListener('click', () => toggleModal(elements.customBreathingModal, false));
            elements.bookModalClose.addEventListener('click', () => toggleModal(elements.bookModal, false));
            elements.focusModalClose.addEventListener('click', () => toggleModal(elements.focusModal, false));
            elements.colorNoiseModalClose.addEventListener('click', () => toggleModal(elements.colorNoiseModal, false));
            elements.playerModalClose.addEventListener('click', stopPlayer);
            
            // Chat input
            elements.therapyChatInput.addEventListener('keypress', handleTherapyChatKeyPress);
        }

        // Navigation functions
        function goHome() {
            window.location.href = 'menu.html';
        }

        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                window.location.href = 'index.html';
            }
        }

        function openCustomBreathing() {
            if (currentUserStats.breathing_level < 2) {
                alert("Custom breathing exercises unlock at Level 2!");
                return;
            }
            toggleModal(elements.customBreathingModal, true);
        }

        function openColorNoises() {
            toggleModal(elements.focusModal, false);
            toggleModal(elements.colorNoiseModal, true);
        }

        // Therapy Chat Functions
        async function sendTherapyMessage() {
            const message = elements.therapyChatInput.value.trim();
            
            if (!message) return;
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = `<p>${message}</p>`;
            elements.therapyChatContainer.appendChild(userMessage);
            
            elements.therapyChatInput.value = '';
            elements.therapyChatContainer.scrollTop = elements.therapyChatContainer.scrollHeight;
            
            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'HTTP-Referer': 'https://project-l-e-a-d-academy.github.io',
                        'X-Title': 'LEAD Wellness App',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat-v3-0324:free',
                        messages: [{
                            role: 'system',
                            content: 'You are a compassionate AI therapy assistant for teenagers. Provide supportive, empathetic responses. Focus on active listening, validation, and gentle guidance. Keep responses conversational and age-appropriate. If someone expresses serious mental health concerns, gently suggest they talk to a trusted adult or professional.'
                        }, {
                            role: 'user',
                            content: message
                        }],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                // Add AI response
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = `<p>${data.choices[0].message.content}</p>`;
                elements.therapyChatContainer.appendChild(aiMessage);
                
                elements.therapyChatContainer.scrollTop = elements.therapyChatContainer.scrollHeight;
                
                // Save chat session
                await saveTherapyChat(message, data.choices[0].message.content);
            } catch (error) {
                console.error('Error sending therapy message:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message ai';
                errorMessage.innerHTML = `<p>I'm having connection issues. Please try again later.</p>`;
                elements.therapyChatContainer.appendChild(errorMessage);
                elements.therapyChatContainer.scrollTop = elements.therapyChatContainer.scrollHeight;
            }
        }

        async function saveTherapyChat(userMessage, aiResponse) {
            try {
                // Check if there's an existing active chat session
                const { data: existingChat, error: fetchError } = await supabase
                    .from('therapy_chats')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                let chatId = null;
                let messages = [];
                
                if (!fetchError && existingChat.length > 0) {
                    // Continue existing chat
                    chatId = existingChat[0].id;
                    messages = existingChat[0].messages;
                }
                
                // Add new messages
                messages.push({
                    role: 'user',
                    content: userMessage,
                    timestamp: new Date().toISOString()
                }, {
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toISOString()
                });
                
                // Generate a session name from user's first message
                let sessionName = 'Therapy Session';
                if (messages.length === 2) { // Only for first message
                    sessionName = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
                }
                
                // Upsert chat session
                const { error } = await supabase
                    .from('therapy_chats')
                    .upsert({
                        id: chatId,
                        user_id: currentUser.id,
                        session_name: sessionName,
                        messages: messages,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
            } catch (error) {
                console.error('Error saving therapy chat:', error);
            }
        }

        function handleTherapyChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendTherapyMessage();
            }
        }

        // Breathing Exercise Functions
        function prepareBreathingExercise(type) {
            currentExerciseType = type;
            elements.fingerPressContainer.style.display = 'block';
            elements.breathingInstruction.textContent = 'Press and hold the button to begin';
        }

        function startFingerPress() {
            fingerPressActive = true;
            fingerPressInterval = setInterval(() => {
                // Check if still pressing every second
                if (!fingerPressActive) {
                    clearInterval(fingerPressInterval);
                    elements.breathingInstruction.textContent = 'Press and hold the button to continue';
                }
            }, 1000);
            
            // Start exercise after 3 seconds of continuous press
            setTimeout(() => {
                if (fingerPressActive) {
                    elements.fingerPressContainer.style.display = 'none';
                    startBreathingExercise(currentExerciseType);
                }
            }, 3000);
        }

        function stopFingerPress() {
            fingerPressActive = false;
            if (fingerPressInterval) {
                clearInterval(fingerPressInterval);
            }
        }

        function startBreathingExercise(type) {
            elements.stopBreathingBtn.style.display = 'inline-block';
            breathingStartTime = Date.now();
            
            // Start duration counter
            breathingDurationInterval = setInterval(updateBreathingDuration, 1000);
            
            let cycles = {
                box: { inhale: 4, hold1: 4, exhale: 4, hold2: 4 },
                deep: { inhale: 4, hold1: 0, exhale: 6, hold2: 0 },
                calm: { inhale: 4, hold1: 7, exhale: 8, hold2: 0 }
            };
            
            let cycle = cycles[type];
            let phase = 0; // 0: inhale, 1: hold1, 2: exhale, 3: hold2
            let count = 0;
            
            const phases = ['inhale', 'hold1', 'exhale', 'hold2'];
            const phaseTexts = ['Inhale', 'Hold', 'Exhale', 'Hold'];
            const phaseDurations = [cycle.inhale, cycle.hold1, cycle.exhale, cycle.hold2];
            
            elements.breathingInstruction.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Breathing - Follow the circle`;
            
            function breathingCycle() {
                if (!breathingTimer) return;
                
                const currentPhase = phases[phase];
                const duration = phaseDurations[phase];
                
                if (duration === 0) {
                    phase = (phase + 1) % 4;
                    return breathingCycle();
                }
                
                elements.breathingText.textContent = `${phaseTexts[phase]} ${duration - count}`;
                
                if (currentPhase === 'inhale') {
                    elements.breathingCircle.className = 'breathing-circle inhale';
                } else if (currentPhase === 'exhale') {
                    elements.breathingCircle.className = 'breathing-circle exhale';
                } else {
                    elements.breathingCircle.className = 'breathing-circle';
                }
                
                count++;
                
                if (count > duration) {
                    count = 0;
                    phase = (phase + 1) % 4;
                }
            }
            
            breathingTimer = setInterval(breathingCycle, 1000);
            breathingCycle();
        }

        function startCustomBreathing() {
            const inhale = parseInt(elements.inhaleDuration.value) || 4;
            const hold = parseInt(elements.holdDuration.value) || 0;
            const exhale = parseInt(elements.exhaleDuration.value) || 6;
            
            toggleModal(elements.customBreathingModal, false);
            
            elements.stopBreathingBtn.style.display = 'inline-block';
            breathingStartTime = Date.now();
            
            // Start duration counter
            breathingDurationInterval = setInterval(updateBreathingDuration, 1000);
            
            let cycle = { inhale: inhale, hold1: hold, exhale: exhale, hold2: 0 };
            let phase = 0; // 0: inhale, 1: hold1, 2: exhale, 3: hold2
            let count = 0;
            
            const phases = ['inhale', 'hold1', 'exhale', 'hold2'];
            const phaseTexts = ['Inhale', 'Hold', 'Exhale', 'Hold'];
            const phaseDurations = [cycle.inhale, cycle.hold1, cycle.exhale, cycle.hold2];
            
            elements.breathingInstruction.textContent = `Custom Breathing (${inhale}-${hold}-${exhale}) - Follow the circle`;
            
            function breathingCycle() {
                if (!breathingTimer) return;
                
                const currentPhase = phases[phase];
                const duration = phaseDurations[phase];
                
                if (duration === 0) {
                    phase = (phase + 1) % 4;
                    return breathingCycle();
                }
                
                elements.breathingText.textContent = `${phaseTexts[phase]} ${duration - count}`;
                
                if (currentPhase === 'inhale') {
                    elements.breathingCircle.className = 'breathing-circle inhale';
                } else if (currentPhase === 'exhale') {
                    elements.breathingCircle.className = 'breathing-circle exhale';
                } else {
                    elements.breathingCircle.className = 'breathing-circle';
                }
                
                count++;
                
                if (count > duration) {
                    count = 0;
                    phase = (phase + 1) % 4;
                }
            }
            
            breathingTimer = setInterval(breathingCycle, 1000);
            breathingCycle();
        }

        function stopBreathingExercise() {
            if (breathingTimer) {
                clearInterval(breathingTimer);
                breathingTimer = null;
            }
            
            if (breathingDurationInterval) {
                clearInterval(breathingDurationInterval);
                breathingDurationInterval = null;
            }
            
            elements.breathingCircle.className = 'breathing-circle';
            elements.breathingText.textContent = 'Session Complete';
            elements.breathingInstruction.textContent = 'Great job! Choose another exercise or close to continue.';
            elements.stopBreathingBtn.style.display = 'none';
            
            // Save session if it lasted more than 7 minutes (420 seconds)
            if (breathingStartTime && Date.now() - breathingStartTime > 420000) {
                saveBreathingSession();
            }
            
            elements.breathingDuration.textContent = '00:00';
            elements.breathingXp.textContent = '0';
        }

        function updateBreathingDuration() {
            if (breathingStartTime) {
                const elapsed = Math.floor((Date.now() - breathingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                                const seconds = elapsed % 60;
                elements.breathingDuration.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update XP display (10 XP per minute)
                const xp = minutes * 10;
                elements.breathingXp.textContent = xp;
                updateXpProgress(currentXp + xp, nextLevelXp);
            }
        }

        async function saveBreathingSession() {
            if (!breathingStartTime) return;
            
            const duration = Math.floor((Date.now() - breathingStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const { data: currentStats } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                    
                // Calculate experience points (10 XP per minute)
                const xpEarned = minutes * 10;
                const currentLevel = currentStats?.breathing_level || 1;
                const currentXp = currentStats?.breathing_xp || 0;
                const totalXp = currentXp + xpEarned;
                const xpNeeded = 100 * currentLevel;
                const levelsGained = Math.floor(totalXp / xpNeeded);
                const newLevel = currentLevel + levelsGained;
                const remainingXp = totalXp % xpNeeded;
                
                // Only show level up modal for levels 5, 10, 15, etc.
                const shouldShowLevelUp = levelsGained > 0 && newLevel % 5 === 0;
                
                // Save breathing session
                const { error: sessionError } = await supabase
                    .from('breathing_sessions')
                    .insert({
                        user_id: user.id,
                        session_type: 'breathing',
                        duration: duration,
                        level: newLevel,
                        xp_earned: xpEarned,
                        custom_pattern: elements.customBreathingBtn.style.display === 'inline-block'
                    });
                    
                if (sessionError) throw sessionError;
                
                // Update user stats
                const { error: statsError } = await supabase
                    .from('user_stats')
                    .upsert({
                        user_id: user.id,
                        total_breathing_sessions: (currentStats?.total_breathing_sessions || 0) + 1,
                        breathing_level: newLevel,
                        breathing_xp: remainingXp,
                        last_session_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    
                if (statsError) throw statsError;
                
                // Show level up message if applicable
                if (levelsGained > 0) {
                    elements.breathingCircle.className = 'breathing-circle inhale';
                    elements.breathingText.textContent = `Level ${newLevel}!`;
                    
                    if (shouldShowLevelUp) {
                        toggleModal(elements.breathingModal, false);
                        alert(`Congratulations! You've reached Level ${newLevel}!`);
                    }
                    
                    setTimeout(() => {
                        elements.breathingCircle.className = 'breathing-circle';
                        elements.breathingText.textContent = 'Session Complete';
                    }, 3000);
                }
                
                await loadUserStats();
            } catch (error) {
                console.error('Error saving breathing session:', error);
            }
        }

        // Book Meditation Functions
        function playBook(title, author, description, duration, url) {
            currentSessionType = 'book';
            currentSessionName = title;
            currentSessionUrl = url;
            
            elements.playerTitle.textContent = title;
            elements.playerDescription.textContent = `${author} ‚Ä¢ ${description}`;
            toggleModal(elements.playerModal, true);
            toggleModal(elements.bookModal, false);
            
            // Load YouTube video
            const videoId = extractVideoId(url);
            elements.youtubeIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
            
            // Start timer
            startPlayerTimer();
        }

        // Focus Mode Functions
        function playFocusSound(name, duration, url, description) {
            currentSessionType = 'focus';
            currentSessionName = name;
            currentSessionUrl = url;
            
            elements.playerTitle.textContent = name;
            elements.playerDescription.textContent = description;
            toggleModal(elements.playerModal, true);
            toggleModal(elements.focusModal, false);
            toggleModal(elements.colorNoiseModal, false);
            
            // Load YouTube video
            const videoId = extractVideoId(url);
            elements.youtubeIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
            
            // Start timer
            startPlayerTimer();
        }

        function playColorNoise(name, description, url) {
            currentSessionType = 'focus';
            currentSessionName = name;
            currentSessionUrl = url;
            
            elements.playerTitle.textContent = name;
            elements.playerDescription.textContent = description;
            toggleModal(elements.playerModal, true);
            toggleModal(elements.colorNoiseModal, false);
            
            // Load YouTube video
            const videoId = extractVideoId(url);
            elements.youtubeIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
            
            // Start timer
            startPlayerTimer();
        }

        function extractVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function startPlayerTimer() {
            playerStartTime = Date.now();
            playerElapsedTime = 0;
            elements.playerTimer.textContent = '00:00';
            elements.sessionProgress.textContent = '0';
            
            if (playerInterval) {
                clearInterval(playerInterval);
            }
            
            playerInterval = setInterval(updatePlayerTimer, 1000);
        }

        function updatePlayerTimer() {
            playerElapsedTime = Math.floor((Date.now() - playerStartTime) / 1000);
            const minutes = Math.floor(playerElapsedTime / 60);
            const seconds = playerElapsedTime % 60;
            
            elements.playerTimer.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update session progress (counts every full minute)
            elements.sessionProgress.textContent = minutes;
            
            // For books, save progress every 15 minutes
            if (currentSessionType === 'book' && minutes > 0 && minutes % 15 === 0) {
                savePlayerSession();
            }
            
            // For focus sounds, save progress every 15 minutes
            if (currentSessionType === 'focus' && minutes > 0 && minutes % 15 === 0) {
                savePlayerSession();
            }
        }

        async function savePlayerSession() {
            if (!playerStartTime) return;
            
            const duration = playerElapsedTime;
            const minutes = Math.floor(duration / 60);
            
            try {
                // First verify the user exists
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                // Get current stats
                const { data: currentStats } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                let sessionTable, sessionData, statsUpdate;
                const xpEarned = minutes * 5; // 5 XP per minute for these activities
                
                if (currentSessionType === 'book') {
                    sessionTable = 'book_sessions';
                    sessionData = {
                        user_id: user.id,
                        book_title: currentSessionName,
                        duration: duration,
                        progress: minutes,
                        completed: minutes >= 15 // Mark as completed if at least 15 minutes
                    };
                    
                    statsUpdate = {
                        total_book_sessions: (currentStats?.total_book_sessions || 0) + 1,
                        last_session_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                } else if (currentSessionType === 'focus') {
                    sessionTable = 'focus_sessions';
                    sessionData = {
                        user_id: user.id,
                        sound_type: currentSessionName,
                        duration: duration,
                        completed: minutes >= 15 // Mark as completed if at least 15 minutes
                    };
                    
                    statsUpdate = {
                        total_focus_sessions: (currentStats?.total_focus_sessions || 0) + 1,
                        last_session_date: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                }
                
                // Save session
                const { error: sessionError } = await supabase
                    .from(sessionTable)
                    .insert(sessionData);
                    
                if (sessionError) throw sessionError;
                
                // Update user stats
                const { error: statsError } = await supabase
                    .from('user_stats')
                    .upsert(statsUpdate);
                    
                if (statsError) throw statsError;
                
                await loadUserStats();
            } catch (error) {
                console.error('Error saving player session:', error);
            }
        }

        function stopPlayer() {
            if (playerInterval) {
                clearInterval(playerInterval);
                playerInterval = null;
            }
            
            // Save session if it lasted more than 15 minutes
            if (playerStartTime && playerElapsedTime >= 900) {
                savePlayerSession();
            }
            
            // Stop YouTube video
            elements.youtubeIframe.src = '';
            toggleModal(elements.playerModal, false);
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                const modal = event.target;
                modal.classList.remove('active');
                document.body.style.overflow = '';
                
                if (modal.id === 'breathingModal') {
                    stopBreathingExercise();
                }
                if (modal.id === 'playerModal') {
                    stopPlayer();
                }
            }
        });

        // Initialize page
        window.addEventListener('load', async () => {
            await checkAuth();
            setupEventListeners();
            showContent();
        });
    </script>
</body>
</html>
